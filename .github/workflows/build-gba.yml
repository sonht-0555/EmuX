name: Build GBA (mGBA)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout EmuX & Setup Emscripten
      uses: actions/checkout@v3
      with:
        path: emux
    
    - uses: mymindstorm/setup-emsdk@v14
      with:
        version: 3.1.46

    - name: Fetch and Build mGBA Core
      run: |
        # 1. Fetch Source
        git clone --depth 1 https://github.com/libretro/libretro-super.git
        cd libretro-super && ./libretro-fetch.sh mgba && cd ..
        
        # 2. Build Core with LTO
        cd libretro-super/libretro-mgba
        emmake make -f Makefile.libretro platform=emscripten -j$(nproc) LTO=1
        
        # 3. Link WASM (Ultra-Optimized)
        CORE_FILE=$(ls mgba_libretro_emscripten.* | grep -E '\.(a|bc)$' | head -n 1)
        echo "Linking with core file: $CORE_FILE"

        emcc "$CORE_FILE" \
          -Oz -flto \
          -s WASM=1 -s USE_ZLIB=1 -s FORCE_FILESYSTEM=1 -s ALLOW_MEMORY_GROWTH=1 \
          -s INITIAL_MEMORY=134217728 -s STACK_SIZE=5242880 -s ENVIRONMENT=web \
          -s EXPORTED_RUNTIME_METHODS='["addFunction","FS","stringToUTF8","UTF8ToString","ccall","cwrap"]' \
          -s EXPORTED_FUNCTIONS='["_retro_init","_retro_run","_retro_load_game","_retro_get_system_av_info","_retro_set_environment","_retro_set_video_refresh","_retro_set_audio_sample","_retro_set_audio_sample_batch","_retro_set_input_poll","_retro_set_input_state","_malloc","_free"]' \
          -s ERROR_ON_UNDEFINED_SYMBOLS=0 -s ASSERTIONS=0 -s ALLOW_TABLE_GROWTH=1 \
          -o mgba.js

    - name: Package & Upload
      run: |
        cd libretro-super/libretro-mgba
        zip -r mgba.zip mgba.js mgba.wasm
        mkdir -p ../../emux/src/core
        cp mgba.zip ../../emux/src/core/
        
    - name: Commit and Push Core
      run: |
        cd emux
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add src/core/mgba.zip
        git commit -m "Update GBA Core: mgba.zip [skip ci]" || exit 0
        
        for i in {1..5}; do
          git pull --rebase origin main
          git push origin main && break || sleep 15
        done
        
    - uses: actions/upload-artifact@v4
      with:
        name: mgba-core
        path: emux/src/core/mgba.zip
