name: Build Genesis (Genesis Plus GX)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout EmuX & Setup Emscripten
      uses: actions/checkout@v3
      with:
        path: emux
    
    - uses: mymindstorm/setup-emsdk@v14
      with:
        version: 3.1.46

    - name: Build Genesis Plus GX using libretro-super
      run: |
        # Clone libretro-super
        git clone --depth 1 https://github.com/libretro/libretro-super.git
        cd libretro-super
        
        # Fetch genesis_plus_gx
        ./libretro-fetch.sh genesis_plus_gx
        
        # Clone libretro-common
        cd ..
        git clone --depth 1 https://github.com/libretro/libretro-common.git
        
        # Build using libretro-super's build script (handles all dependencies)
        cd libretro-super/libretro-genesis_plus_gx
        
        # Use the Makefile with proper flags - disable VFS to avoid rfopen dependency
        emmake make -f Makefile.libretro platform=emscripten -j$(nproc) \
          STATIC_LINKING=1 \
          STATIC_LINKING_LINK=1 \
          USE_LIBRETRO_VFS=0
        
        # Compile libretro-common compat and utility functions
        C="../../libretro-common"
        emcc -O2 -I"$C/include" -c "$C/compat/compat_strl.c" -o compat_strl.o
        emcc -O2 -I"$C/include" -c "$C/compat/compat_strcasestr.c" -o compat_strcasestr.o
        emcc -O2 -I"$C/include" -c "$C/compat/compat_posix_string.c" -o compat_posix_string.o || true
        emcc -O2 -I"$C/include" -c "$C/compat/fopen_utf8.c" -o fopen_utf8.o || true
        emcc -O2 -I"$C/include" -c "$C/encodings/encoding_utf.c" -o encoding_utf.o || true
        emcc -O2 -I"$C/include" -c "$C/file/file_path.c" -o file_path.o
        emcc -O2 -I"$C/include" -c "$C/streams/file_stream.c" -o file_stream.o || true
        emcc -O2 -I"$C/include" -c "$C/string/stdstring.c" -o stdstring.o
        emcc -O2 -I"$C/include" -c "$C/lists/string_list.c" -o string_list.o
        emcc -O2 -I"$C/include" -c "$C/vfs/vfs_implementation.c" -o vfs_implementation.o || true
        
        # Create stub implementations for rf* functions (legacy file wrappers)
        cat > rf_stubs.c << 'EOF'
        #include <stdio.h>
        #include <stdarg.h>
        void* rfopen(const char* path, const char* mode) { return fopen(path, mode); }
        int rfclose(void* stream) { return fclose((FILE*)stream); }
        size_t rfread(void* ptr, size_t size, size_t count, void* stream) { return fread(ptr, size, count, (FILE*)stream); }
        size_t rfwrite(const void* ptr, size_t size, size_t count, void* stream) { return fwrite(ptr, size, count, (FILE*)stream); }
        int rfseek(void* stream, long offset, int whence) { return fseek((FILE*)stream, offset, whence); }
        long rftell(void* stream) { return ftell((FILE*)stream); }
        int rfeof(void* stream) { return feof((FILE*)stream); }
        int rferror(void* stream) { return ferror((FILE*)stream); }
        char* rfgets(char* str, int n, void* stream) { return fgets(str, n, (FILE*)stream); }
        int rfputc(int c, void* stream) { return fputc(c, (FILE*)stream); }
        int rfprintf(void* stream, const char* format, ...) {
            va_list args;
            va_start(args, format);
            int ret = vfprintf((FILE*)stream, format, args);
            va_end(args);
            return ret;
        }
        EOF
        emcc -O2 -c rf_stubs.c -o rf_stubs.o
        
        # List compiled objects
        ls -la *.o
        
        # The .bc file should have everything compiled in
        CORE_FILE=$(ls genesis_plus_gx_libretro_emscripten.bc)
        
        # Link with all libretro-common objects (use wildcard to include all .o files)
        emcc "$CORE_FILE" *.o \
          -O2 \
          -s WASM=1 \
          -s ALLOW_MEMORY_GROWTH=1 \
          -s ALLOW_TABLE_GROWTH=1 \
          -s INITIAL_MEMORY=67108864 \
          -s ENVIRONMENT=web \
          -s EXPORTED_RUNTIME_METHODS='["addFunction","FS","stringToUTF8","UTF8ToString","ccall","cwrap"]' \
          -s EXPORTED_FUNCTIONS='["_retro_init","_retro_run","_retro_load_game","_retro_get_system_av_info","_retro_set_environment","_retro_set_video_refresh","_retro_set_audio_sample","_retro_set_audio_sample_batch","_retro_set_input_poll","_retro_set_input_state","_malloc","_free"]' \
          -s ERROR_ON_UNDEFINED_SYMBOLS=0 \
          -o genesis.js

    - name: Package & Upload
      run: |
        mkdir -p emux/src/core
        cp libretro-super/libretro-genesis_plus_gx/genesis.{js,wasm} emux/src/core/

    - uses: actions/upload-artifact@v4
      with:
        name: genesis
        path: emux/src/core/genesis.*
