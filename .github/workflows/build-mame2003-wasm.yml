name: Build MAME 2003 WASM

on:
  push:
    paths:
      - '.github/workflows/build-mame2003-wasm.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 3.1.46
        actions-cache-folder: 'emsdk-cache-mame2003'

    - name: Clone MAME 2003
      run: git clone --depth 1 https://github.com/libretro/mame2003-libretro.git

    - name: Build MAME 2003 (Fixed Linking)
      run: |
        cd mame2003-libretro
        make clean
        
        # 1. Build MAME Core
        emmake make -f Makefile platform=emscripten -j$(nproc)
        
        # 2. Clone libretro-common mới vào thư mục gốc để chắc chắn có file
        if [ ! -d "libretro-common" ]; then
           git clone --depth 1 https://github.com/libretro/libretro-common.git libretro-common
        fi
        
        # 3. Compile các file thiếu từ thư mục vừa clone
        COMMON_DIR="libretro-common"
        INCLUDE_FLAGS="-I. -Isrc -Isrc/libretro -I$COMMON_DIR/include -DHAVE_VFS -DHAVE_STDINT_H -DHAVE_STDLIB_H"
        
        echo "Locating and compiling common files..."
        
        # Hàm helper để tìm và compile file
        compile_common() {
            local file_name=$1
            local output_name=$2
            # Tìm file trong libretro-common
            local file_path=$(find $COMMON_DIR -name "$file_name" | head -n 1)
            
            if [ -z "$file_path" ]; then
                echo "WARNING: Could not find $file_name"
            else
                echo "Compiling $file_path -> $output_name"
                emcc -O2 $INCLUDE_FLAGS -c "$file_path" -o "$output_name"
            fi
        }

        compile_common "md5.c" "md5.o"
        compile_common "file_path.c" "file_path.o"
        compile_common "interface_stream.c" "interface_stream.o"
        compile_common "memory_stream.c" "memory_stream.o"
        compile_common "file_stream.c" "file_stream.o"
        compile_common "vfs_implementation.c" "vfs_implementation.o"
        compile_common "stdstring.c" "stdstring.o"
        compile_common "compat_strl.c" "compat_strl.o"
        compile_common "memalign.c" "memalign.o"
        compile_common "encoding_utf.c" "encoding_utf.o"

        # 4. Link tất cả
        echo "Linking everything into final bitcode..."
        # Dùng --whole-archive để ép lấy hết symbol
        emcc -r -Wl,--whole-archive mame2003_libretro_emscripten.bc -Wl,--no-whole-archive *.o -o final_mame2003.bc

        # 5. Tạo WASM
        # Build Debug (-g2) để xem tên chính xác của hàm gây lỗi
        emcc \
        final_mame2003.bc \
        -O2 -g2 \
        -s WASM=1 \
        -s USE_ZLIB=1 \
        -s ALLOW_MEMORY_GROWTH=1 \
        -s INITIAL_MEMORY=268435456 \
        -s ENVIRONMENT=web \
        -s MODULARIZE=0 \
        -s EXPORT_NAME="Module" \
        -s FORCE_FILESYSTEM=1 \
        -s EXPORTED_RUNTIME_METHODS='["addFunction","FS","stringToUTF8"]' \
        -s EXPORTED_FUNCTIONS='["_retro_init","_retro_deinit","_retro_run","_retro_load_game","_retro_unload_game","_retro_set_environment","_retro_set_video_refresh","_retro_set_audio_sample","_retro_set_audio_sample_batch","_retro_set_input_poll","_retro_set_input_state","_retro_get_system_av_info","_malloc","_free"]' \
        -s ALLOW_TABLE_GROWTH=1 \
        -s ERROR_ON_UNDEFINED_SYMBOLS=0 \
        -s ALIASING_FUNCTION_POINTERS=0 \
        -s ASSERTIONS=1 \
        -o ../src/core/mame2003_libretro.js

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mame2003-wasm
        path: src/core/mame2003_libretro.*