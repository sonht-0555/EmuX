name: Build MAME 2003 WASM

on:
  push:
    paths:
      - '.github/workflows/build-mame2003-wasm.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 3.1.46
        actions-cache-folder: 'emsdk-cache-mame2003'

    - name: Clone MAME 2003
      run: git clone --depth 1 https://github.com/libretro/mame2003-libretro.git

    - name: Prepare Dependencies
      run: |
        cd mame2003-libretro
        # Ensure libretro-common exists (either as submodule or clone)
        if [ ! -d "src/libretro/libretro-common" ]; then
          git clone --depth 1 https://github.com/libretro/libretro-common.git src/libretro/libretro-common
        fi

    - name: Build MAME 2003 (DEBUG MODE)
      run: |
        cd mame2003-libretro
        make clean
        emmake make -f Makefile platform=emscripten -j$(nproc) DEBUG=1
        
        # Tìm file sản phẩm chính của Core (thường là .a hoặc .bc)
        CORE_LIB=$(find . -maxdepth 1 -name "*_libretro*.a" -o -name "*_libretro*.bc" | head -n 1)
        echo "Linking core library: $CORE_LIB"
        
        # Link chính xác file thư viện này
        emcc \
        $CORE_LIB \
        -O1 -g2 \
        -s WASM=1 \
        -s USE_ZLIB=1 \
        -s ALLOW_MEMORY_GROWTH=1 \
        -s INITIAL_MEMORY=268435456 \
        -s STACK_SIZE=8388608 \
        -s ENVIRONMENT=web \
        -s EXPORT_NAME="'Module'" \
        -s FORCE_FILESYSTEM=1 \
        -s ERROR_ON_UNDEFINED_SYMBOLS=0 \
        -s EMULATE_FUNCTION_POINTER_CASTS=1 \
        -s ASSERTIONS=2 \
        -s DEMANGLE_SUPPORT=1 \
        -s STACK_OVERFLOW_CHECK=2 \
        -s EXPORTED_RUNTIME_METHODS='["ccall","cwrap","addFunction","removeFunction","FS","HEAPU8","HEAPU16","HEAP16","HEAP32","HEAPU32","UTF8ToString","getValue","setValue","stringToUTF8"]' \
        -s EXPORTED_FUNCTIONS='["_retro_init","_retro_deinit","_retro_run","_retro_load_game","_retro_unload_game","_retro_set_environment","_retro_set_video_refresh","_retro_set_audio_sample","_retro_set_audio_sample_batch","_retro_set_input_poll","_retro_set_input_state","_retro_get_system_av_info","_malloc","_free"]' \
        -s ALLOW_TABLE_GROWTH=1 \
        -o ../src/core/mame2003_libretro.js

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mame2003-wasm-debug
        path: src/core/mame2003_libretro.*
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mame2003-wasm-debug
        path: src/core/mame2003_libretro.*