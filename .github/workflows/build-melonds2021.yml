name: Build melonDS 2021 Core

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: build-melonds2021
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        path: emux

    - uses: mymindstorm/setup-emsdk@v14
      with:
        version: 3.1.46

    - name: Fetch
      run: |
        mkdir -p libretro-super
        # Sử dụng đúng repository melonDS và checkout tag phiên bản 2021
        git clone --depth 1 --branch before-rebase-20210922 https://github.com/libretro/melonDS.git libretro-super/libretro-melonds2021

    - name: Build
      run: |
        cd libretro-super/libretro-melonds2021
        # Sửa Makefile để xóa bỏ các cờ linker không tương thích với Emscripten
        sed -i 's/-Wl,--no-undefined//g' Makefile
        sed -i 's/-Wl,--version-script=[^ ]*//g' Makefile
        # Build ra các file .o (bỏ qua lỗi link bitcode cuối cùng nếu có)
        emmake make platform=emscripten -j$(nproc) || true
        
        # Link các objects thành file wasm/js
        ALL_OBJS=$(find . -name "*.o")
        emcc $ALL_OBJS -Oz -flto -DNDEBUG \
          -s WASM=1 -s USE_ZLIB=1 -s ENVIRONMENT=web \
          -s ALLOW_MEMORY_GROWTH=1 -s WASM_BIGINT=1 --no-heap-copy -s ALLOW_TABLE_GROWTH=1 \
          -s INITIAL_MEMORY=512mb -s STACK_SIZE=32mb \
          -s EXPORTED_RUNTIME_METHODS='["addFunction","FS","stringToUTF8","UTF8ToString","ccall","cwrap","getValue","setValue"]' \
          -s EXPORTED_FUNCTIONS='["_retro_init","_retro_run","_retro_load_game","_retro_get_system_av_info","_retro_set_environment","_retro_set_video_refresh","_retro_set_audio_sample","_retro_set_audio_sample_batch","_retro_set_input_poll","_retro_set_input_state","_malloc","_free","_retro_serialize_size","_retro_serialize","_retro_unserialize"]' \
          -s ERROR_ON_UNDEFINED_SYMBOLS=0 -s ASSERTIONS=0 \
          -o melonds2021.js
        zip -j melonds2021.zip melonds2021.js melonds2021.wasm

    - uses: actions/upload-artifact@v4
      with:
        name: melonds2021-core
        path: libretro-super/libretro-melonds2021/*.zip
