name: Build libretro RACE WASM (Super Light)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: latest
        actions-cache-folder: emsdk-cache

    - name: Clone libretro RACE
      run: |
        git clone https://github.com/libretro/RACE.git
        cd RACE
        if [ ! -d "libretro-common" ]; then
          git clone https://github.com/libretro/libretro-common.git libretro-common
        else
          cd libretro-common && git pull && cd ..
        fi

    - name: Build libretro core (emscripten)
      run: |
        cd RACE
        make platform=emscripten HAVE_VFS=1 CC="emcc -fno-strict-aliasing" CXX="em++ -fno-strict-aliasing" AR=emar RANLIB=emranlib -j$(nproc)
        
        # Surgically compile ONLY missing common files with unique names
        emcc -O3 -I. -Ilibretro-common/include -DHAVE_VFS -DHAVE_STDINT_H -c libretro-common/streams/file_stream.c -o file_stream.fix.o
        emcc -O3 -I. -Ilibretro-common/include -DHAVE_VFS -DHAVE_STDINT_H -c libretro-common/vfs/vfs_implementation.c -o vfs_implementation.fix.o
        emcc -O3 -I. -Ilibretro-common/include -DHAVE_VFS -DHAVE_STDINT_H -c libretro-common/compat/compat_strl.c -o compat_strl.fix.o

    - name: Link WASM + JS
      run: |
        cd RACE
        
        # Link all objects including our surgical fixes
        emcc \
        -O3 \
        $(find . -name "*.o" ! -name ".*") \
        -s WASM=1 \
        -s EMULATE_FUNCTION_POINTER_CASTS=1 \
        -s EXPORT_ALL=1 \
        -s ASSERTIONS=1 \
        -s ERROR_ON_UNDEFINED_SYMBOLS=0 \
        -s LEGACY_RUNTIME=1 \
        -s ALLOW_MEMORY_GROWTH=1 \
        -s ALLOW_TABLE_GROWTH=1 \
        -s ENVIRONMENT=web \
        -s EXPORTED_RUNTIME_METHODS='["addFunction","removeFunction","cwrap","ccall","FS","HEAPF64","HEAPU8","HEAP16","HEAPU16","HEAPU32","HEAP32"]' \
        -s EXPORTED_FUNCTIONS='["_retro_init","_retro_deinit","_retro_run","_retro_load_game","_retro_unload_game","_retro_set_environment","_retro_set_video_refresh","_retro_set_audio_sample","_retro_set_audio_sample_batch","_retro_set_input_poll","_retro_set_input_state","_retro_get_system_av_info","_retro_set_controller_port_device","_malloc","_free"]' \
        -o ../src/core/neogeo.js

    - name: Upload WASM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: neogeo-wasm
        path: |
          src/core/neogeo.js
          src/core/neogeo.wasm
