name: Build libretro Nestopia WASM

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: latest
        actions-cache-folder: emsdk-cache

    - name: Clone libretro Nestopia
      run: |
        git clone --recursive https://github.com/libretro/nestopia.git
        cd nestopia/libretro

    - name: Build libretro core (emscripten)
      run: |
        cd nestopia/libretro
        make platform=emscripten CC=emcc CXX=em++ AR=emar RANLIB=emranlib -j$(nproc)

    - name: Link WASM + JS
      run: |
        cd nestopia/libretro
        
        # Nestopia produces nestopia_libretro_emscripten.bc
        mv nestopia_libretro_emscripten.bc libretro_core.a
        
        emcc \
        -O3 \
        -s WASM=1 \
        -s LEGACY_RUNTIME=1 \
        -s ALLOW_MEMORY_GROWTH=1 \
        -s ALLOW_TABLE_GROWTH=1 \
        -s ENVIRONMENT=web \
        -s EXPORTED_RUNTIME_METHODS='["addFunction","removeFunction","cwrap","ccall","FS","HEAPF64","HEAPU8","HEAP16","HEAPU16","HEAPU32","HEAP32"]' \
        -s EXPORTED_FUNCTIONS='["_retro_init","_retro_deinit","_retro_run","_retro_load_game","_retro_unload_game","_retro_set_environment","_retro_set_video_refresh","_retro_set_audio_sample","_retro_set_audio_sample_batch","_retro_set_input_poll","_retro_set_input_state","_retro_get_system_av_info","_retro_set_controller_port_device","_malloc","_free"]' \
        -Wl,--whole-archive libretro_core.a -Wl,--no-whole-archive \
        -o ../../src/core/nestopia.js

    - name: Upload WASM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nestopia-wasm
        path: |
          src/core/nestopia.js
          src/core/nestopia.wasm
