name: Test FBNeo Native Build

on:
  workflow_dispatch: # Cho phép bạn bấm chạy thủ công từ tab Actions

jobs:
  test-build-fbneo:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout EmuX
      uses: actions/checkout@v3
      with:
        path: emux

    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 3.1.46

    - name: Fetch FBNeo Source
      run: |
        git clone --depth 1 https://github.com/libretro/libretro-super.git
        cd libretro-super && ./libretro-fetch.sh fbneo

    - name: Compile FBNeo with Native VFS
      run: |
        # Build retro_glue.c trước để lấy các hàm string_to_lower, vfs...
        emcc -c emux/.github/workflows/retro_glue.c -o retro_glue.o -O3 -flto -DNDEBUG -s USE_ZLIB=1
        
        cd libretro-super/libretro-fbneo/src/burner/libretro
        emmake make platform=emscripten -j$(nproc) LTO=1 WANT_VFS=1

    - name: Link Arcade JS (Brute-force Object Linking)
      run: |
        # Lấy file .o của retro_glue đã build ở bước trước
        GLUE_OBJ=$(pwd)/retro_glue.o
        cd libretro-super/libretro-fbneo
        
        # Tìm tất cả các file .o của core
        ALL_OBJS=$(find . -name "*.o")
        
        emcc $ALL_OBJS $GLUE_OBJ -O3 -flto -DNDEBUG \
          -s WASM=1 -s USE_ZLIB=1 -s ENVIRONMENT=web \
          -s ALLOW_MEMORY_GROWTH=1 -s WASM_BIGINT=1 --no-heap-copy \
          -s ALLOW_TABLE_GROWTH=1 -s FORCE_FILESYSTEM=1 \
          -s INITIAL_MEMORY=256mb -s STACK_SIZE=8mb \
          -s EXPORTED_RUNTIME_METHODS='["addFunction","FS","stringToUTF8","UTF8ToString","ccall","cwrap"]' \
          -s EXPORTED_FUNCTIONS='["_retro_init","_retro_run","_retro_load_game","_retro_get_system_av_info","_retro_set_environment","_retro_set_video_refresh","_retro_set_audio_sample","_retro_set_audio_sample_batch","_retro_set_input_poll","_retro_set_input_state","_string_to_lower","_string_replace_substring","_path_basename","_path_parent_dir","_path_is_absolute","_path_remove_extension","_path_get_extension","_path_mkdir","_path_is_directory","_retro_opendir_include_hidden","_retro_readdir","_retro_dirent_get_name","_retro_dirent_is_dir","_retro_closedir","_filestream_open","_filestream_read","_filestream_write","_filestream_seek","_filestream_tell","_filestream_close","_filestream_get_size","_rfopen","_rfread","_rfwrite","_rfseek","_rftell","_rfsize","_rfclose","_rfget_size","_retro_vfs_file_open_impl","_retro_vfs_file_close_impl","_retro_vfs_file_get_size_impl","_retro_vfs_file_read_impl","_retro_vfs_file_write_impl","_retro_vfs_file_seek_impl","_retro_vfs_file_tell_impl","_malloc","_free"]' \
          -s ERROR_ON_UNDEFINED_SYMBOLS=0 -s ASSERTIONS=0 \
          -o arcade_test.js
        
        zip -j arcade_test.zip arcade_test.js arcade_test.wasm

    - name: Upload Test Core
      uses: actions/upload-artifact@v4
      with:
        name: fbneo-test-core
        path: libretro-super/libretro-fbneo/arcade_test.zip
