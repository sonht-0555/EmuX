<!DOCTYPE html>
<html>
    <head>
        <title>Gambatte Simple Loader</title>
        <style>
            body {
                background: #000;
                color: #0f0;
                font-family: monospace;
                padding: 20px;
                line-height: 1.4;
            }

            #log {
                white-space: pre-wrap;
                word-break: break-all;
            }

            .success {
                color: #0f0;
            }

            .error {
                color: #f00;
                font-weight: bold;
            }

            .info {
                color: #0af;
            }
        </style>
    </head>
    <canvas id="canvas" width="160" height="144" style="width: 320px; height: 288px; image-rendering: pixelated;"></canvas>
    <body>
        <div id="log">Starting Gambatte Core...</div>

        <script>
            const logNode = document.getElementById('log');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const imageData = ctx.createImageData(160, 144);

            function log(msg, type = 'info') {
                const span = document.createElement('div');
                span.className = type;
                span.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                logNode.appendChild(span);
            }

            window.Module = {
                print: (m) => log(m, 'success'),
                printErr: (m) => log(m, 'error'),
                onRuntimeInitialized: () => {
                    log("WASM Runtime Ready.");
                    runCore();
                }
            };

            async function runCore() {
                try {
                    log("Loading test.gbc...");
                    const res = await fetch('test.gbc');
                    const data = new Uint8Array(await res.arrayBuffer());
                    log(`ROM Size: ${data.length} bytes`);

                    let pixelFormat = 0; // 0: XRGB1555, 1: XRGB8888, 2: RGB565

                    // 1. Setup Environment
                    const logCallback = Module.addFunction((level, fmt, argptr) => {
                        let msg = Module.UTF8ToString(fmt);
                        if (msg.includes('%s') && argptr) {
                            try {
                                const subPtr = Module.getValue(argptr, 'i32');
                                if (subPtr) msg = msg.replace('%s', Module.UTF8ToString(subPtr));
                            } catch (e) { }
                        }
                        log(`[Core] ${msg}`);
                    }, 'viii');

                    Module._retro_set_environment(Module.addFunction((cmd, ptr) => {
                        // Commands that MUST return true/1 for Gambatte to load
                        const booleanCommands = [1, 2, 3, 8, 10, 16, 21, 22, 39, 59, 70];

                        if (cmd === 10) { // SET_PIXEL_FORMAT
                            if (ptr) pixelFormat = Module.getValue(ptr, 'i32');
                            return true;
                        }

                        if (booleanCommands.includes(cmd)) {
                            if (ptr) {
                                Module.HEAPU8[ptr] = 1;
                                Module.HEAPU8[ptr + 1] = 0; Module.HEAPU8[ptr + 2] = 0; Module.HEAPU8[ptr + 3] = 0;
                            }
                            return true;
                        }

                        if (cmd === 27) { // GET_LOG_INTERFACE
                            if (ptr) Module.setValue(ptr, logCallback, 'i32');
                            return true;
                        }

                        if (cmd === 9) { // GET_SYSTEM_DIRECTORY
                            if (ptr) {
                                const pathPtr = Module._malloc(2);
                                Module.stringToUTF8(".", pathPtr, 2);
                                Module.setValue(ptr, pathPtr, 'i32');
                            }
                            return true;
                        }
                        return false;
                    }, 'iii'));

                    const videoCallback = Module.addFunction((dataPtr, w, h, pitch) => {
                        if (!dataPtr) return;
                        const pixels = imageData.data;

                        if (pixelFormat === 2) { // RGB565
                            const src = new Uint16Array(Module.HEAPU8.buffer, dataPtr, w * h);
                            for (let i = 0; i < w * h; i++) {
                                const c = src[i];
                                const r = ((c >> 11) & 0x1f) << 3;
                                const g = ((c >> 5) & 0x3f) << 2;
                                const b = (c & 0x1f) << 3;
                                pixels[i * 4] = r;
                                pixels[i * 4 + 1] = g;
                                pixels[i * 4 + 2] = b;
                                pixels[i * 4 + 3] = 255;
                            }
                        } else { // XRGB8888
                            const src = new Uint32Array(Module.HEAPU8.buffer, dataPtr, w * h);
                            for (let i = 0; i < w * h; i++) {
                                const c = src[i];
                                pixels[i * 4] = (c >> 16) & 0xff;
                                pixels[i * 4 + 1] = (c >> 8) & 0xff;
                                pixels[i * 4 + 2] = c & 0xff;
                                pixels[i * 4 + 3] = 255;
                            }
                        }
                        ctx.putImageData(imageData, 0, 0);
                    }, 'viiii');

                    const dummyAudio = Module.addFunction(() => { }, 'vii');
                    const dummyAudioBatch = Module.addFunction((d, f) => f, 'iii');
                    const dummyPoll = Module.addFunction(() => { }, 'v');
                    const dummyInput = Module.addFunction(() => 0, 'iiiii');

                    if (Module._retro_set_video_refresh) Module._retro_set_video_refresh(videoCallback);
                    if (Module._retro_set_audio_sample) Module._retro_set_audio_sample(dummyAudio);
                    if (Module._retro_set_audio_sample_batch) Module._retro_set_audio_sample_batch(dummyAudioBatch);
                    if (Module._retro_set_input_poll) Module._retro_set_input_poll(dummyPoll);
                    if (Module._retro_set_input_state) Module._retro_set_input_state(dummyInput);

                    // 2. Init Core
                    Module._retro_init();

                    // 3. Load Game
                    const gameInfo = Module._malloc(120);
                    // Zero out the struct
                    for (let i = 0; i < 120; i++) Module.HEAPU8[gameInfo + i] = 0;

                    const romBuf = Module._malloc(data.length);
                    Module.HEAPU8.set(data, romBuf);

                    const pathPtr = Module._malloc(10);
                    Module.stringToUTF8("test.gbc", pathPtr, 10);

                    Module.setValue(gameInfo + 0, pathPtr, 'i32'); // path
                    Module.setValue(gameInfo + 4, romBuf, 'i32'); // data
                    Module.setValue(gameInfo + 8, data.length, 'i32'); // size

                    if (Module._retro_load_game(gameInfo)) {
                        log("SUCCESS: Running game loop...", "success");
                        function loop() {
                            Module._retro_run();
                            requestAnimationFrame(loop);
                        }
                        loop();
                    } else {
                        log("FAILED: retro_load_game", "error");
                    }

                } catch (e) {
                    log(`CRASH: ${e.message}`, "error");
                }
            }
        </script>
        <script src="sameboy_core.js"></script>
    </body>
</html>