<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NES Emulator</title>
  <style>
    body { margin: 0; padding: 10px; }
    #controls { 
      margin-bottom: 10px; 
      position: relative;
      z-index: 10;
    }
    #gameContainer { 
      position: relative;
      z-index: 1;
    }
    button, input { margin: 5px; }
  </style>
</head>
<body>
  <h1>Emulator Nostalgist.js</h1>
  
  <div id="controls">
    <input type="file" id="romFile" accept=".smc,.sfc">
    <button id="loadBtn">Tải Game</button>
    <button id="speedBtn" disabled>Speed: 1x</button>
  </div>
  
  <div id="gameContainer"></div>
  
  <div id="status"></div>

  <script type="module">

    // retroarchConfig cấu hình
    const retroarchConfig = {
      video_vsync: "true",
      video_max_swapchain_images: "2",
      fastforward_ratio: "1.0",
      run_ahead_enabled: "false",
      audio_enable: "true",
      audio_sync: "true",
      video_shader_enable: "false",
      video_smooth: "false",
      video_scale_integer: "true"
    };

      // import { Nostalgist } from 'https://cdn.jsdelivr.net/npm/nostalgist@latest/dist/nostalgist.js';

    const romFile = document.getElementById('romFile');
    const loadBtn = document.getElementById('loadBtn');
    const speedBtn = document.getElementById('speedBtn');
    const gameContainer = document.getElementById('gameContainer');
    const status = document.getElementById('status');

    let nostalgist = null;
    let audioUnlocked = false;
      let _silentOsc = null;
    let currentSpeed = 1;

    async function unlockAudio() {
      if (audioUnlocked) return;
      try {
        let ctx = window._emuxAudioCtx;
        if (!ctx) {
          ctx = new (window.AudioContext || window.webkitAudioContext)();
          window._emuxAudioCtx = ctx;
        }
        if (ctx.state === 'suspended') {
          await ctx.resume();
        }
        // Tạo silent oscillator giữ context luôn running (giống retroassembly)
        if (!_silentOsc) {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = 'sine';
          osc.frequency.value = 20; // rất thấp, không nghe được
          gain.gain.value = 0.00001; // gần như im lặng
          osc.connect(gain).connect(ctx.destination);
          osc.start();
          _silentOsc = { osc, gain };
        }
        audioUnlocked = true;
      } catch (e) {
        // Không làm gì nếu lỗi
      }
    }

    // Toggle speed 1x/2x
    speedBtn.addEventListener('click', () => {
      if (!nostalgist) return;
      // Nostalgist không hỗ trợ setSpeed, chỉ có thể gửi lệnh fast forward
      if (currentSpeed === 1) {
        nostalgist.sendCommand('FAST_FORWARD');
        currentSpeed = 1.25;
        speedBtn.textContent = 'Speed: 2x';
      } else {
        nostalgist.sendCommand('FAST_FORWARD'); // toggle lại
        currentSpeed = 1;
        speedBtn.textContent = 'Speed: 1x';
      }
    });

    loadBtn.addEventListener('click', async () => {
      await unlockAudio();
      const file = romFile.files[0];
      
      if (!file) {
        status.textContent = 'Vui lòng chọn file ROM (.smc, .sfc)';
        return;
      }

      if (!file.name.endsWith('.smc') && !file.name.endsWith('.sfc')) {
        status.textContent = 'Chỉ hỗ trợ file .smc hoặc .sfc';
        return;
      }

      try {
        status.textContent = 'Đang tải game...';
        
        // Dọn dẹp instance cũ nếu có
        if (nostalgist) {
          nostalgist.exit();
          gameContainer.innerHTML = '';
        }

        // Đọc file
        const arrayBuffer = await file.arrayBuffer();
        const romData = new Uint8Array(arrayBuffer);

        // Khởi tạo Nostalgist

        nostalgist = await Nostalgist.snes(romData, {
          element: gameContainer,
          size: { width: 512, height: 480 },
          ...retroarchConfig // Thêm cấu hình retroarchConfig vào options
        });

        status.textContent = `Game "${file.name}" đã tải thành công! Dùng phím mũi tên + Z/X/A/S để chơi`;
        speedBtn.disabled = false;
        currentSpeed = 1;
        speedBtn.textContent = 'Speed: 1x';
        
      } catch (error) {
        status.textContent = 'Lỗi: ' + error.message;
        console.error(error);
      }
    });

    // Dọn dẹp khi đóng trang
    window.addEventListener('beforeunload', () => {
      if (nostalgist) {
        nostalgist.exit();
      }
      // Dọn dẹp oscillator khi rời trang
      if (_silentOsc) {
        try {
          _silentOsc.osc.stop();
          _silentOsc.osc.disconnect();
          _silentOsc.gain.disconnect();
        } catch {}
        _silentOsc = null;
      }
    });
  </script>
  <script src="https://unpkg.com/nostalgist"></script>
</body>
</html>