<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>EmuX Debug 1.5 (PeerJS 1.5.4)</title>
        <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
        <style>
            :root {
                --primary: #00d2ff;
                --bg: #0b1c26;
                --surface: #142e3a;
                --text: #e6f7ff;
            }

            * {
                box-sizing: border-box;
                -webkit-tap-highlight-color: transparent;
            }

            body {
                font-family: -apple-system, system-ui, sans-serif;
                background: var(--bg);
                color: var(--text);
                margin: 0;
                padding: 15px;
                display: flex;
                flex-direction: column;
                align-items: center;
                min-height: 100vh;
            }

            .app {
                width: 100%;
                max-width: 400px;
            }

            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                margin-bottom: 20px;
            }

            .box {
                background: var(--surface);
                border-radius: 16px;
                padding: 15px;
                margin-bottom: 12px;
                border: 1px solid rgba(0, 210, 255, 0.2);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            .id-display {
                font-family: monospace;
                font-size: 1.8rem;
                font-weight: bold;
                color: var(--primary);
                letter-spacing: 2px;
            }

            .status-bar {
                display: flex;
                gap: 8px;
                margin-top: 10px;
            }

            .stat {
                font-size: 0.6rem;
                padding: 3px 8px;
                border-radius: 10px;
                background: #333;
                color: #888;
                border: 1px solid #444;
                transition: 0.3s;
            }

            .stat.active {
                background: #004400;
                color: #00ff00;
                border-color: #00ff00;
                box-shadow: 0 0 8px #00ff00;
            }

            .input-group {
                display: flex;
                gap: 8px;
                margin-top: 5px;
            }

            input {
                flex: 1;
                background: #081218;
                border: 1px solid #30809b;
                border-radius: 10px;
                color: white;
                padding: 12px;
                font-size: 1.1rem;
                outline: none;
                text-transform: uppercase;
                font-weight: bold;
            }

            button {
                background: var(--primary);
                color: #000;
                border: none;
                border-radius: 10px;
                padding: 12px 20px;
                font-weight: bold;
                cursor: pointer;
            }

            #log {
                background: #000;
                border-radius: 12px;
                padding: 10px;
                height: 350px;
                overflow-y: auto;
                font-family: monospace;
                font-size: 0.75rem;
                border: 1px solid #1a3a4a;
                white-space: pre-wrap;
                line-height: 1.4;
            }

            .sys {
                color: #888;
                font-style: italic;
            }

            .ice {
                color: #ffa500;
            }

            .success {
                color: #00ff00;
                font-weight: bold;
            }

            .error {
                color: #ff4444;
            }
        </style>
    </head>
    <body>
        <div class="app">
            <div class="header">
                <span style="font-weight: bold; opacity: 0.8;">EmuX Node 1.5</span>
                <button onclick="location.reload()" style="padding: 5px 10px; font-size: 0.7rem; background: #222; color: #888;">RELOAD</button>
            </div>

            <div class="box">
                <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 5px;">MY ID (4 CHARS):</div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="id-display" id="my-id">....</span>
                    <button onclick="copyId()" id="copy-btn" style="background: transparent; color: var(--primary); font-size: 0.8rem;">COPY</button>
                </div>
                <div class="status-bar">
                    <span id="st-socket" class="stat">SIGNAL</span>
                    <span id="st-ice" class="stat">ICE</span>
                    <span id="st-data" class="stat">DATA</span>
                </div>
            </div>

            <div class="box">
                <div class="input-group">
                    <input type="text" id="host-id" placeholder="ID MÃY KIA" maxlength="4" autocomplete="off" oninput="this.value=this.value.toUpperCase()">
                    <button id="connect-btn">CONNECT</button>
                </div>
            </div>

            <div id="log"></div>
        </div>

        <script>
            const logEl = document.getElementById('log');
            const stSocket = document.getElementById('st-socket');
            const stIce = document.getElementById('st-ice');
            const stData = document.getElementById('st-data');

            function addLog(msg, type = '') {
                const div = document.createElement('div');
                div.className = type;
                div.textContent = `[${new Date().toLocaleTimeString('en-GB', {hour12: false})}] ${msg}`;
                logEl.appendChild(div);
                logEl.scrollTop = logEl.scrollHeight;
            }

            function copyId() {
                const id = document.getElementById('my-id').innerText;
                navigator.clipboard.writeText(id);
                const btn = document.getElementById('copy-btn');
                btn.innerText = "COPIED!";
                setTimeout(() => btn.innerText = "COPY", 2000);
            }

            // FULL COMBO ICE CONFIG (Tá»« báº£n chat)
            const iceConfig = {
                'iceServers': [
                    {urls: 'stun:stun.l.google.com:19302'},
                    {urls: 'turn:openrelayproject.org:3478', username: 'openrelayproject', credential: 'openrelayproject'},
                    {urls: 'turn:turn.anyfirewall.com:443?transport=tcp', username: 'webrtc', credential: 'webrtc'}
                ]
            };

            const shortId = Math.random().toString(36).substring(2, 6).toUpperCase();
            document.getElementById('my-id').innerText = shortId;

            const peer = new Peer(shortId, {
                config: iceConfig,
                debug: 1
            });

            peer.on('open', (id) => {
                stSocket.classList.add('active');
                addLog(`>>> ID: ${id} READY`, 'success');
            });

            peer.on('connection', (conn) => {
                addLog(`>>> INCOMING: ${conn.peer}`, 'ice');
                setupConnection(conn);
            });

            document.getElementById('connect-btn').onclick = () => {
                const target = document.getElementById('host-id').value;
                if (!target) return;
                addLog(`>>> CONNECTING TO: ${target}...`, 'sys');
                const conn = peer.connect(target, {reliable: true});
                setupConnection(conn);
            };

            function setupConnection(conn) {
                const checkPC = setInterval(() => {
                    if (conn.peerConnection) {
                        clearInterval(checkPC);
                        const pc = conn.peerConnection;
                        pc.oniceconnectionstatechange = () => {
                            addLog(`ICE: ${pc.iceConnectionState}`, 'ice');
                            if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed') {
                                stIce.classList.add('active');
                            }
                        };
                        pc.onicecandidate = (e) => {
                            if (e.candidate) addLog(`ðŸ“ Candidate: ${e.candidate.type}`, 'sys');
                        };
                    }
                }, 100);

                conn.on('open', () => {
                    stData.classList.add('active');
                    addLog("ðŸš€ DATA CHANNEL OPEN!", "success");
                    conn.send("PING_TEST");
                });

                conn.on('data', (data) => {
                    addLog(`ðŸ“© DATA: ${data}`);
                    if (data === "PING_TEST") conn.send("PONG_TEST");
                });

                conn.on('error', (err) => addLog(`!!! ERR: ${err}`, 'error'));
                conn.on('close', () => {
                    stData.classList.remove('active');
                    addLog(">>> CLOSED", 'error');
                });
            }
        </script>
    </body>
</html>