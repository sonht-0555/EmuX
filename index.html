<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Clone Test (PeerJS 1.3.1 - Cue System Style)</title>
        <!-- S·ª≠ d·ª•ng ƒë√∫ng phi√™n b·∫£n 1.3.1 t·ª´ CDN gi·ªëng Cue System -->
        <script src="https://cdn.jsdelivr.net/npm/peerjs@1.3.1/dist/peerjs.min.js"></script>
        <style>
            body {
                font-family: sans-serif;
                background: #121212;
                color: #00ff00;
                padding: 20px;
            }

            #log {
                background: #000;
                border: 1px solid #00ff00;
                padding: 10px;
                height: 400px;
                overflow-y: scroll;
                font-family: monospace;
            }

            .box {
                border: 1px dashed #00ff00;
                padding: 15px;
                margin-bottom: 20px;
            }

            input {
                background: #000;
                color: #00ff00;
                border: 1px solid #00ff00;
                padding: 5px;
            }

            button {
                background: #00ff00;
                color: #000;
                border: none;
                padding: 5px 15px;
                cursor: pointer;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="box">
            <h3>1. Kh·ªüi t·∫°o (Clone 1.3.1)</h3>
            <p>My Peer ID: <strong id="display-id">...ƒëang ch·ªù...</strong></p>
        </div>

        <div class="box">
            <h3>2. K·∫øt n·ªëi ƒë·∫øn Host</h3>
            <input type="text" id="host-id" placeholder="Nh·∫≠p ID m√°y kia">
            <button id="connect-btn">CONNECT (Host)</button>
        </div>

        <div id="log"></div>

        <script>
            const logEl = document.getElementById('log');
            const idEl = document.getElementById('display-id');

            function addLog(msg) {
                const time = new Date().toLocaleTimeString();
                logEl.innerHTML += `<div>[${time}] ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
                console.log(msg);
            }

            // KH·ªûI T·∫†O ZERO-CONFIG GI·ªêNG H·ªÜT CUE SYSTEM
            // Kh√¥ng truy·ªÅn config, kh√¥ng truy·ªÅn iceServers
            const peer = new Peer({debug: 3});

            peer.on('open', (id) => {
                idEl.textContent = id;
                addLog(">>> Peer ƒë√£ m·ªü th√†nh c√¥ng. ID: " + id);
            });

            peer.on('connection', (conn) => {
                addLog(">>> Nh·∫≠n k·∫øt n·ªëi t·ª´: " + conn.peer);
                setupConn(conn);
            });

            peer.on('error', (err) => {
                addLog("!!! L·ªñI PEER: " + err.type);
            });

            document.getElementById('connect-btn').onclick = () => {
                const target = document.getElementById('host-id').value;
                if (!target) return alert("Nh·∫≠p ID ƒëi b·∫°n!");

                addLog("ƒêang th·ª≠ k·∫øt n·ªëi t·ªõi: " + target);
                // Cue System d√πng m·∫∑c ƒë·ªãnh, reliable: true
                const conn = peer.connect(target, {reliable: true});
                setupConn(conn);
            };

            function setupConn(conn) {
                // Ch·ªù PeerConnection ƒë∆∞·ª£c t·∫°o ƒë·ªÉ intercept log ICE
                const checkPC = setInterval(() => {
                    if (conn.peerConnection) {
                        clearInterval(checkPC);
                        const pc = conn.peerConnection;
                        addLog("--- B·∫Øt ƒë·∫ßu theo d√µi WebRTC Candidates ---");

                        pc.onicecandidate = (event) => {
                            if (event.candidate) {
                                addLog(`Found: ${event.candidate.type} | ${event.candidate.address || 'mDNS'}`);
                                if (event.candidate.type === 'relay') {
                                    addLog("üéØ PH√ÅT HI·ªÜN RELAY! (Th√†nh c√¥ng gi·ªëng Chidokun)");
                                }
                            } else {
                                addLog("‚úÖ Qu√©t xong ICE Candidates.");
                            }
                        };

                        pc.oniceconnectionstatechange = () => {
                            addLog("ICE State changed: " + pc.iceConnectionState);
                        };
                    }
                }, 100);

                conn.on('open', () => {
                    addLog("üöÄ K·∫æT N·ªêI D·ªÆ LI·ªÜU ƒê√É M·ªû!");
                    conn.send("Hello t·ª´ Clone Test 1.3.1");
                });

                conn.on('data', (data) => {
                    addLog("üì© NH·∫¨N D·ªÆ LI·ªÜU: " + data);
                });
            }
        </script>
    </body>
</html>