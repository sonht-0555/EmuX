<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NES Emulator</title>
</head>
<body>
  <h1>NES Emulator với Nostalgist.js</h1>
  
  <input type="file" id="romFile" accept=".nes">
  <button id="loadBtn">Tải Game</button>
  
  <div id="gameContainer"></div>
  
  <div id="status"></div>

  <script type="module">
    import { Nostalgist } from 'https://cdn.jsdelivr.net/npm/nostalgist@latest/dist/nostalgist.js';

    const romFile = document.getElementById('romFile');
    const loadBtn = document.getElementById('loadBtn');
    const gameContainer = document.getElementById('gameContainer');
    const status = document.getElementById('status');

    let nostalgist = null;
    let audioUnlocked = false;

    async function unlockAudio() {
      if (audioUnlocked) return;
      try {
        let ctx = window._emuxAudioCtx;
        if (!ctx) {
          ctx = new (window.AudioContext || window.webkitAudioContext)();
          window._emuxAudioCtx = ctx;
        }
        if (ctx.state === 'suspended') {
          await ctx.resume();
        }
        audioUnlocked = true;
      } catch (e) {
        // Không làm gì nếu lỗi
      }
    }

    loadBtn.addEventListener('click', async () => {
      await unlockAudio();
      const file = romFile.files[0];
      
      if (!file) {
        status.textContent = 'Vui lòng chọn file ROM (.nes)';
        return;
      }

      if (!file.name.endsWith('.nes')) {
        status.textContent = 'Chỉ hỗ trợ file .nes';
        return;
      }

      try {
        status.textContent = 'Đang tải game...';
        
        // Dọn dẹp instance cũ nếu có
        if (nostalgist) {
          nostalgist.exit();
          gameContainer.innerHTML = '';
        }

        // Đọc file
        const arrayBuffer = await file.arrayBuffer();
        const romData = new Uint8Array(arrayBuffer);

        // Khởi tạo Nostalgist
        nostalgist = await Nostalgist.nes(romData, {
          element: gameContainer,
          size: { width: 512, height: 480 }
        });

        status.textContent = `Game "${file.name}" đã tải thành công! Dùng phím mũi tên + Z/X để chơi`;
        
      } catch (error) {
        status.textContent = 'Lỗi: ' + error.message;
        console.error(error);
      }
    });

    // Dọn dẹp khi đóng trang
    window.addEventListener('beforeunload', () => {
      if (nostalgist) {
        nostalgist.exit();
      }
    });
  </script>
</body>
</html>