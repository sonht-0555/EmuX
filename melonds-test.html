<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>EmuX - melonDS</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; touch-action: none; overflow: hidden; }
        .header { padding: 5px; text-align: center; }
        #canvas { max-width: 100vw; height: auto; image-rendering: pixelated; background: #111; cursor: crosshair; touch-action: none; border: 1px solid #333; }
        .controller { width: 100%; box-sizing: border-box; padding: 10px; display: grid; grid-template-columns: auto 1fr auto; gap: 0px; align-items: center; justify-items: center; }
        .btn { width: 44px; height: 44px; padding: 0; cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: center; background: #222; color: #fff; border: 1px solid #444; border-radius: 6px; font-size: 16px; font-weight: bold; }
        .btn:active { background: #555; transform: scale(0.95); }
        .btn-mid { display: flex; flex-direction: column; gap: 10px; }
        #status { font-size: 10px; color: #aaa; margin: 2px 0; }
    </style>
</head>
<body>
    <div class="header">
        <label style="cursor:pointer; background:#222; padding:5px 15px; border:1px solid #444; font-size:12px; border-radius:4px;">
            OPEN ROM <input type="file" id="rom" onchange="runCore()" style="display:none">
        </label>
        <div id="status">Ready</div>
    </div>

    <canvas id="canvas"></canvas>

    <div class="controller">
        <div style="display:grid; grid-template-areas:'. u .' 'l . r' '. d .'; gap:4px;">
            <button class="btn" style="grid-area:u" onpointerdown="setK(4,1)" onpointerup="setK(4,0)">U</button>
            <button class="btn" style="grid-area:l" onpointerdown="setK(6,1)" onpointerup="setK(6,0)">L</button>
            <button class="btn" style="grid-area:r" onpointerdown="setK(7,1)" onpointerup="setK(7,0)">R</button>
            <button class="btn" style="grid-area:d" onpointerdown="setK(5,1)" onpointerup="setK(5,0)">D</button>
        </div>
        <div class="btn-mid">
            <button class="btn" style="height:25px; width:65px; font-size:10px;" onpointerdown="setK(2,1)" onpointerup="setK(2,0)">SELECT</button>
            <button class="btn" style="height:25px; width:65px; font-size:10px;" onpointerdown="setK(3,1)" onpointerup="setK(3,0)">START</button>
        </div>
        <div style="display:grid; grid-template-areas:'. y .' 'x . b' '. a .'; gap:4px;">
            <button class="btn" style="grid-area:y" onpointerdown="setK(1,1)" onpointerup="setK(1,0)">Y</button>
            <button class="btn" style="grid-area:x" onpointerdown="setK(9,1)" onpointerup="setK(9,0)">X</button>
            <button class="btn" style="grid-area:b" onpointerdown="setK(0,1)" onpointerup="setK(0,0)">B</button>
            <button class="btn" style="grid-area:a" onpointerdown="setK(8,1)" onpointerup="setK(8,0)">A</button>
        </div>
    </div>

    <script>
        (function() {
            const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d', {alpha: false});
            canvas.width = 256; canvas.height = 384; 
            const imgData = ctx.createImageData(256, 384);
            const statusEl = document.getElementById('status');
            
            let _pX = 0, _pY = 0, _pD = 0;
            const _btn = new Int16Array(16);
            window.setK = (i, v) => { _btn[i] = v ? 32767 : 0; };

            let _oT, _oL, _oS;
            window.Module = {
                onRuntimeInitialized: async () => {
                    _oT = Module._malloc(6); Module.stringToUTF8('Touch', _oT, 6);
                    _oL = Module._malloc(11); Module.stringToUTF8('Top/Bottom', _oL, 11);
                    _oS = Module._malloc(2); Module.stringToUTF8('.', _oS, 2);
                    statusEl.innerText = "Kernel Loaded";
                }
            };

            function _v_refresh(ptr) {
                if (!ptr) return;
                new Uint32Array(imgData.data.buffer).set(new Uint32Array(Module.HEAPU8.buffer, ptr, 256 * 384));
                ctx.putImageData(imgData, 0, 0);
            }

            function _env(cmd, data) {
                if (cmd === 15) {
                    const key = Module.UTF8ToString(Module.HEAP32[data >> 2]);
                    if (key === 'melonds_touch_mode') { Module.HEAP32[(data >> 2) + 1] = _oT; return true; }
                    if (key === 'melonds_screen_layout') { Module.HEAP32[(data >> 2) + 1] = _oL; return true; }
                }
                if (cmd === 9) { Module.HEAP32[data >> 2] = _oS; return true; }
                return cmd === 10;
            }

            canvas.onpointerdown = canvas.onpointermove = e => {
                const r = canvas.getBoundingClientRect();
                const xn = (e.clientX - r.left) / r.width;
                const yn = (e.clientY - r.top) / r.height;
                if (yn > 0.5) {
                    _pD = 1;
                    _pX = Math.floor(xn * 65535 - 32768);
                    _pY = Math.floor((yn - 0.5) * 2 * 32767);
                } else { _pD = 0; }
                e.preventDefault();
            };
            canvas.onpointerup = () => { _pD = 0; };

            window.runCore = async function() {
                const romData = new Uint8Array(await document.getElementById('rom').files[0].arrayBuffer());
                for (let f of ['bios7.bin', 'bios9.bin', 'firmware.bin']) {
                    try {
                        const res = await fetch(`nds bios/${f}`);
                        if (res.ok) Module.FS.writeFile(f, new Uint8Array(await res.arrayBuffer()));
                        try { Module.FS.mkdir('/system'); } catch(e) {}
                        Module.FS.writeFile(`/system/${f}`, Module.FS.readFile(f));
                    } catch(e) {}
                }

                try {
                    Module._retro_set_video_refresh(Module.addFunction(_v_refresh, 'viiii'));
                    Module._retro_set_input_poll(Module.addFunction(()=>{}, 'v'));
                    Module._retro_set_input_state(Module.addFunction((p,dev,idx,id) => {
                        if (dev === 1) return (id < 12) ? _btn[id] : 0;
                        if (dev === 6) { // Device 6: POINTER (Standard)
                            if (id === 0) return _pX;
                            if (id === 1) return _pY;
                            if (id === 2) return _pD;
                        }
                        return 0;
                    }, 'iiiii'));
                    
                    Module._retro_set_environment(Module.addFunction(_env, 'iii'));
                    Module._retro_set_audio_sample(Module.addFunction(()=>{}, 'vii'));
                    Module._retro_set_audio_sample_batch(Module.addFunction((d,f)=>f, 'iii'));
                    Module._retro_init();

                    if (Module._retro_set_controller_port_device) Module._retro_set_controller_port_device(0, 6);

                    const rP = Module._malloc(romData.length);
                    Module.HEAPU8.set(romData, rP);
                    const iP = Module._malloc(16);
                    Module.HEAP32[iP>>2]=Module._malloc(10);
                    Module.stringToUTF8("game.nds", Module.HEAP32[iP>>2], 10);
                    Module.HEAP32[(iP>>2)+1]=rP; Module.HEAP32[(iP>>2)+2]=romData.length;

                    if (Module._retro_load_game(iP)) {
                        const loop = () => { Module._retro_run(); requestAnimationFrame(loop); };
                        loop();
                    }
                } catch(e) { console.error(e); }
            };
        })();
    </script>
    <script src="/melonds/nds.js"></script>
</body>
</html>
