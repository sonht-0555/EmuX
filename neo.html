<!DOCTYPE html>
<html>

<body>
    <input type="file" id="romInput" accept=".zip">
    <canvas id="canvas"></canvas>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function env_cb(cmd, data) {
            if (cmd === 11 || cmd === 12 || cmd === 10) return 1;
            if (cmd === 31 || cmd === 37) {
                const w = Module.HEAP32[data >> 2], h = Module.HEAP32[(data >> 2) + 1];
                if (w > 0 && h > 0 && (canvas.width !== w || canvas.height !== h)) {
                    canvas.width = w; canvas.height = h;
                    Module.img = ctx.createImageData(w, h);
                }
                return 1;
            }
            if (cmd === 15) { // GET_VARIABLE
                const key = Module.UTF8ToString(Module.HEAP32[data >> 2]);
                let val = (key === "fbneo-vertical-mode") ? "Enabled" : (key === "fbneo-sample-rate" ? "44100" : null);
                if (val) {
                    if (!Module._v) Module._v = {};
                    if (!Module._v[val]) {
                        const p = Module._malloc(32);
                        Module.stringToUTF8(val, p, 32);
                        Module._v[val] = p;
                    }
                    Module.HEAP32[(data >> 2) + 1] = Module._v[val];
                    return 1;
                }
            }
            if (cmd === 33 || cmd === 9) {
                const p = Module._malloc(2); Module.stringToUTF8("/", p, 2);
                Module.HEAP32[data >> 2] = p;
                return 1;
            }
            return 0;
        }

        function video_refresh_cb(data, w, h, p) {
            if (canvas.width !== w || canvas.height !== h) {
                canvas.width = w; canvas.height = h;
                Module.img = ctx.createImageData(w, h);
            }
            const dst = Module.img.data;
            const bpp = p / w;
            if (bpp === 2) {
                const src = Module.HEAPU16; const off = data >> 1;
                for (let y = 0, i = 0; y < h; y++) {
                    const line = off + y * (p >> 1);
                    for (let x = 0; x < w; x++) {
                        const pix = src[line + x];
                        dst[i++] = ((pix >> 11) & 31) * 8; dst[i++] = ((pix >> 5) & 63) * 4;
                        dst[i++] = (pix & 31) * 8; dst[i++] = 255;
                    }
                }
            } else {
                const src = Module.HEAPU32; const off = data >> 2;
                for (let y = 0, i = 0; y < h; y++) {
                    const line = off + y * (p >> 2);
                    for (let x = 0; x < w; x++) {
                        const pix = src[line + x];
                        dst[i++] = (pix >> 16) & 255; dst[i++] = (pix >> 8) & 255;
                        dst[i++] = pix & 255; dst[i++] = 255;
                    }
                }
            }
            ctx.putImageData(Module.img, 0, 0);
        }

        var Module = { onRuntimeInitialized: () => console.log("Ready") };
        const keys = {};
        window.onkeydown = e => keys[e.code] = true;
        window.onkeyup = e => keys[e.code] = false;

        function input_state_cb(port, device, index, id) {
            const map = { 0: 'KeyZ', 1: 'KeyX', 2: 'ShiftLeft', 3: 'Enter', 4: 'ArrowUp', 5: 'ArrowDown', 6: 'ArrowLeft', 7: 'ArrowRight' };
            return (port === 0 && device === 1 && keys[map[id]]) ? 1 : 0;
        }

        document.getElementById('romInput').onchange = async (e) => {
            const file = e.target.files[0];
            const path = '/' + file.name;
            Module.FS.writeFile(path, new Uint8Array(await file.arrayBuffer()));

            Module._retro_set_environment(Module.addFunction(env_cb, "iii"));
            Module._retro_set_video_refresh(Module.addFunction(video_refresh_cb, "viiii"));
            Module._retro_set_audio_sample(Module.addFunction(() => { }, "vii"));
            Module._retro_set_audio_sample_batch(Module.addFunction((d, f) => f, "iii"));
            Module._retro_set_input_poll(Module.addFunction(() => { }, "v"));
            Module._retro_set_input_state(Module.addFunction(input_state_cb, "iiiii"));

            Module._retro_init();
            const pPtr = Module._malloc(256); Module.stringToUTF8(path, pPtr, 256);
            const info = Module._malloc(16); Module.HEAP32[info >> 2] = pPtr;
            Module.HEAP32[(info >> 2) + 1] = Module.HEAP32[(info >> 2) + 2] = Module.HEAP32[(info >> 2) + 3] = 0;

            if (Module.ccall('retro_load_game', 'number', ['number'], [info])) {
                const tick = () => { Module._retro_run(); requestAnimationFrame(tick); }; tick();
            }
        };

        const script = document.createElement('script');
        script.src = 'src/core/fbneo_libretro.js?v=' + Date.now();
        document.body.appendChild(script);
    </script>
</body>

</html>