var activeVars={},POINTER_CACHE={};const getPointer=(t,e)=>POINTER_CACHE[t]?POINTER_CACHE[t]:(e=Module._malloc(t.length+1),Module.stringToUTF8(t,e,t.length+1),POINTER_CACHE[t]=e,e);function env_cb(t,e){const n=Number(e)>>2;if(15===t){const t=Module.UTF8ToString(Module.HEAP32[n]);if(activeVars[t])return Module.HEAP32[n+1]=getPointer(activeVars[t]),!0}return 9===t?(Module.HEAP32[n]=getPointer("."),!0):10===t}const CORE_CONFIG=[{ext:".nes",script:"./src/core/nes.zip",btns:{"btn-1":["A",8],"btn-3":["B",0],"btn-l":["",""],"btn-r":["",""],"btn-select":["",2],"btn-start":["",3]}},{ext:".ngp,.ngc",script:"./src/core/ngp.zip",btns:{"btn-1":["A",0],"btn-3":["B",8],"btn-l":["",""],"btn-r":["",""],"btn-select":["",2],"btn-start":["",3]}},{ext:".gb,.gbc",script:"./src/core/gba.zip",btns:{"btn-1":["A",8],"btn-3":["B",0],"btn-l":["",""],"btn-r":["",""],"btn-select":["",2],"btn-start":["",3]}},{ext:".gba",script:"./src/core/gba.zip",btns:{"btn-1":["A",8],"btn-3":["B",0],"btn-l":["",10],"btn-r":["",11],"btn-select":["",2],"btn-start":["",3]}},{ext:".md,.gen",script:"./src/core/genesis.zip",btns:{"btn-3":["A",1],"btn-1":["B",0],"btn-2":["C",8],"btn-l":["",""],"btn-r":["",""],"btn-select":["",2],"btn-start":["",3]}},{ext:".smc,.sfc",script:"./src/core/snes2010.zip",btns:{"btn-1":["A",8],"btn-2":["X",9],"btn-3":["B",0],"btn-4":["Y",1],"btn-l":["",10],"btn-r":["",11],"btn-select":["",2],"btn-start":["",3]}},{ext:".zip",script:"./src/core/arcade.zip",btns:{"btn-1":["A",0],"btn-3":["B",8],"btn-2":["C",1],"btn-4":["D",9],"btn-l":["",""],"btn-r":["",""],"btn-select":["",2],"btn-start":["",3]},bios:["./src/core/bios/neogeo.zip"],vars:{"fbneo-allow-depth-32":"Disabled","fbneo-sample-interpolation":"4-point","fbneo-fm-interpolation":"linear","fbneo-lowpass-filter":"Disabled","fbneo-samplerate":"44100","fbneo-cpu-speed-adjust":"100","fbneo-diagnostic-input":"Disabled"}},{ext:".nds",script:"./src/core/nds2021.zip",btns:{"btn-1":["A",8],"btn-2":["X",9],"btn-3":["B",0],"btn-4":["Y",1],"btn-l":["",10],"btn-r":["",11],"btn-select":["",2],"btn-start":["",3]},bios:["./src/core/bios/bios7.bin","./src/core/bios/bios9.bin","./src/core/bios/firmware.bin"],vars:{melonds_console_mode:"DS",melonds_boot_directly:"Enabled",melonds_screen_layout:"Top/Bottom",melonds_screen_gap:"0",melonds_hybrid_small_screen:"Disabled",melonds_swapscreen_mode:"Disabled",melonds_randomize_mac_address:"Disabled",melonds_touch_mode:"Touch",melonds_dsi_sdcard:"Disabled",melonds_mic_input:"None",melonds_audio_bitrate:"Low",melonds_audio_interpolation:"None",melonds_use_fw_settings:"Disabled",melonds_language:"English"}},{ext:".bin,.iso,.img,.cue,.pbp",script:"./src/core/ps1.zip",btns:{"btn-1":["A",8],"btn-2":["X",9],"btn-3":["B",0],"btn-4":["Y",1],"btn-l":["",10],"btn-r":["",11],"btn-select":["",2],"btn-start":["",3]},bios:["./src/core/bios/scph5501.bin"]}];var isRunning=!1;async function unzip(t,e){return new Promise((n,i)=>{fflate.unzip(t,(t,i)=>{if(t)return n({});const s={};for(let t in i)t.endsWith("/")||0!==i[t].length&&(t.includes("__MACOSX/")||e&&!e.test(t)||(s[t]=i[t]));n(s)})})}async function initCore(t){isRunning=!0,switch0.hidden=!1,await notifi("","","---","",!0);const e=t.name.toLowerCase().endsWith(".zip");let n=t.name,i=new Uint8Array(await t.arrayBuffer());if(e){const t=await unzip(i,/\.(gba|gbc|gb|smc|sfc|nes|md|gen|ngp|ngc|nds|img|cue|pbp)$/i),e=Object.keys(t)[0];e&&(n=e,i=t[e])}const s=CORE_CONFIG.find(t=>t.ext.split(",").map(t=>t.trim().toLowerCase()).filter(t=>t).some(t=>n.toLowerCase().endsWith(t)||n.toLowerCase()===t.replace(".","")));activeVars=s.vars||{},updateButtons(s.btns);let o=s.script;const r=o.includes("arcade"),a=o.includes("nds");if(o.endsWith(".zip")){await notifi("","#","--","",!0);const t=await fetch(o);if(!t.ok)return;const e=await unzip(new Uint8Array(await t.arrayBuffer()),/\.(js|wasm)$/i),n=Object.keys(e).find(t=>t.endsWith(".js")),i=Object.keys(e).find(t=>t.endsWith(".wasm"));if(!n||!i)return;let s=e[n],r=s.length;for(;r>0&&0===s[r-1];)r--;o=URL.createObjectURL(new Blob([s.slice(0,r)],{type:"application/javascript"})),window.wasmUrl=URL.createObjectURL(new Blob([e[i]],{type:"application/wasm"}))}return new Promise(async e=>{await notifi("","##","-","",!0);const c=document.getElementById("canvas");window.Module={isArcade:r,isNDS:a,canvas:c,print:()=>{},printErr:()=>{},locateFile:t=>t.endsWith(".wasm")&&window.wasmUrl||t,async onRuntimeInitialized(){const t=Module._malloc(i.length),o=Module._malloc(16);let c;[[Module._retro_set_environment,env_cb,"iii"],[Module._retro_set_video_refresh,video_cb,"viiii"],[Module._retro_set_audio_sample,audio_cb,"vii"],[Module._retro_set_audio_sample_batch,audio_batch_cb,"iii"],[Module._retro_set_input_poll,input_poll_cb,"v"],[Module._retro_set_input_state,input_state_cb,"iiiii"]].forEach(([t,e,n])=>{t(Module.addFunction(e,n))}),Module._retro_init(),await notifi("","###","","",!0),s.bios&&await Promise.all(s.bios.map(async t=>{const e=await fetch(t).catch(()=>null);if(e?.ok){const n=new Uint8Array(await e.arrayBuffer()),i=t.split("/").pop();Module.FS.writeFile("/"+i,n)}})),a&&Module._retro_set_controller_port_device&&Module._retro_set_controller_port_device(0,6),c=r?"/"+n:a?"/game.nds":"/game."+n.toLowerCase().split(".").pop(),Module.FS.writeFile(c,i);const l=[getPointer(c),0,0,0];r||(Module.HEAPU8.set(i,t),l[1]=t,l[2]=i.length),Module.HEAPU32.set(l,Number(o)>>2),Module._retro_load_game(o);const b=Module._malloc(120);Module._retro_get_system_av_info(b),initAudio(Module.HEAPF64[Number(b)+32>>3]/48e3),audioContext.resume(),Module._free(b),function t(){isRunning&&Module._retro_run(),requestAnimationFrame(t)}(),await loadState(),await timer(!0),e()}};const l=document.createElement("script");l.src=o,document.body.appendChild(l),gameName=t.name})}