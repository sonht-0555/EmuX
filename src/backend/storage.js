let databaseCache=null;const DATABASE_NAME="EmuxDB",STORES={games:["nes","sfc","smc","gba","gb","gbc","bin","rom","md","gen","ngp","ngc","nds","iso","img","cue","pbp","zip","pce"],saves:["sav","srm","sram"],states:["ss1","ss2","ss3","ss4","ss5","ss6","ss7","ss8","ss9","ss0"]};function getAllStoreNames(){return Object.keys(STORES)}function storeForFilename(e){if(!e||"string"!=typeof e)return"games";const t=e.split(".").pop()?.toLowerCase();if(!t)return"games";return getAllStoreNames().find(e=>STORES[e].includes(t))||"games"}async function getDB(){if(databaseCache)return databaseCache;const e=e=>new Promise((t,s)=>{const n=indexedDB.open("EmuxDB",e);e&&(n.onupgradeneeded=e=>{const t=e.target.result;getAllStoreNames().forEach(e=>{t.objectStoreNames.contains(e)||t.createObjectStore(e)})}),n.onsuccess=e=>t(e.target.result),n.onerror=s}),t=await e();return getAllStoreNames().filter(e=>!t.objectStoreNames.contains(e)).length?(t.close(),databaseCache=await e(t.version+1)):databaseCache=t,databaseCache}async function emuxDB(e,t){const s=await getDB(),n=storeForFilename(String(t||e)),o=s.transaction(n,t?"readwrite":"readonly"),r=o.objectStore(n);return new Promise((s,n)=>{if(t){let a=e;a instanceof ArrayBuffer&&(a=new Uint8Array(a)),r.put(a,t),o.oncomplete=()=>s(!0),o.onerror=e=>n(e)}else{const t=r.get(e);t.onsuccess=()=>s(t.result),t.onerror=e=>n(e)}})}async function listStore(e){const t=await getDB(),s=e=>new Promise((s,n)=>{if(!t.objectStoreNames.contains(e))return s([]);const o=t.transaction(e,"readonly").objectStore(e).getAllKeys();o.onsuccess=()=>{const e=o.result.map(e=>String(e));s(e)},o.onerror=n});if(!e){const e={};for(const t of getAllStoreNames())e[t]=await s(t);return e}return s(e)}async function deleteFromStore(e){const t=await getDB(),s=storeForFilename(String(e));return new Promise((n,o)=>{const r=t.transaction(s,"readwrite");r.objectStore(s).delete(e),r.oncomplete=()=>n(!0),r.onerror=e=>o(e)})}async function downloadFromStore(e){const t=await emuxDB(e);if(!t)return message("File not found!");const s=URL.createObjectURL(new Blob([t])),n=document.createElement("a");n.href=s,n.download=e,n.click(),URL.revokeObjectURL(s),message("[#]_Exported!")}