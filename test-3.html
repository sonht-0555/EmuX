<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>EmuX Hybrid 3.3 (Optimized for 4G VN)</title>
        <style>
            :root {
                --primary: #00ff88;
                --bg: #050a0f;
                --surface: #0f1a24;
                --text: #e0f0ff;
            }

            body {
                font-family: monospace;
                background: var(--bg);
                color: var(--text);
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .app {
                width: 100%;
                max-width: 500px;
            }

            .box {
                background: var(--surface);
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 15px;
                border: 1px solid #1a3040;
            }

            .id-val {
                font-size: 2rem;
                font-weight: bold;
                color: var(--primary);
            }

            .status-badge {
                font-size: 0.7rem;
                padding: 4px 10px;
                border-radius: 4px;
                background: #333;
                margin-left: 5px;
            }

            .state-p2p {
                background: #004422;
                color: #00ff88;
            }

            .state-relay {
                background: #443300;
                color: #ffcc00;
            }

            input {
                width: 100%;
                background: #000;
                border: 1px solid #1a3040;
                border-radius: 4px;
                color: #fff;
                padding: 12px;
                margin: 10px 0;
                font-size: 1.2rem;
            }

            button {
                width: 100%;
                background: var(--primary);
                color: #050a0f;
                border: none;
                border-radius: 4px;
                padding: 12px;
                font-weight: bold;
                cursor: pointer;
            }

            #log {
                background: #000;
                border-radius: 4px;
                padding: 15px;
                height: 350px;
                overflow-y: auto;
                font-size: 0.7rem;
                border: 1px solid #1a3040;
                color: #888;
            }

            .tag {
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="app">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <b>EMUX HYBRID v3.3</b>
                <div id="conn-mode" class="status-badge">INIT...</div>
            </div>

            <div class="box">
                <div style="font-size: 0.7rem; opacity: 0.6;">NODE ID: <span id="my-id" class="id-val">....</span></div>
                <div id="ping-display" style="margin-top: 10px; font-weight: bold;">Ping: --ms</div>
            </div>

            <div class="box">
                <input type="text" id="target-id" placeholder="PEER ID" maxlength="4" oninput="this.value=this.value.toUpperCase()">
                <button onclick="startConnect()">CONNECT (HYBRID)</button>
            </div>

            <div id="log"></div>
        </div>

        <script>
            const RELAY_URL = 'wss://emux-relay.fly.dev/ws';
            const myId = Math.random().toString(36).substring(2, 6).toUpperCase();
            document.getElementById('my-id').innerText = myId;

            let ws, pc, dc, targetId;
            let isP2P = false;
            let iceCandidatesBuffer = [];

            function addLog(msg, color = '#888') {
                const div = document.createElement('div');
                div.style.color = color;
                div.textContent = `[${new Date().toLocaleTimeString('en-GB', {hour12: false})}] ${msg}`;
                const log = document.getElementById('log');
                log.appendChild(div);
                log.scrollTop = log.scrollHeight;
            }

            function initWS() {
                ws = new WebSocket(`${RELAY_URL}?id=${myId}`);
                ws.onopen = () => {
                    addLog('>>> SIGNALING READY (FLY.IO)', '#00ff88');
                    updateStatus('SIGNALLING', 'relay');
                };
                ws.onmessage = (e) => handleSignalling(JSON.parse(e.data));
                ws.onclose = () => setTimeout(initWS, 2000);
            }

            function updateStatus(text, mode) {
                const b = document.getElementById('conn-mode');
                b.innerText = text;
                b.className = 'status-badge state-' + mode;
            }

            async function startConnect() {
                targetId = document.getElementById('target-id').value;
                if (!targetId) return;
                addLog(`>>> ATTEMPTING CONNECTION TO ${targetId}...`);

                setupPC();
                dc = pc.createDataChannel('data', {prioritized: true});
                bindDC(dc);

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                sendRelay('offer', offer);
            }

            function setupPC() {
                if (pc) pc.close();
                pc = new RTCPeerConnection({
                    iceServers: [
                        {urls: 'stun:stun.l.google.com:19302'},
                        {urls: 'stun:stun1.l.google.com:19302'},
                        {urls: 'turn:openrelayproject.org:3478', username: 'openrelayproject', credential: 'openrelayproject'},
                        {urls: 'turn:turn.anyfirewall.com:443?transport=tcp', username: 'webrtc', credential: 'webrtc'}
                    ]
                });

                pc.onicecandidate = (e) => {
                    if (e.candidate) sendRelay('candidate', e.candidate);
                };

                pc.oniceconnectionstatechange = () => {
                    addLog(`ICE: ${pc.iceConnectionState}`);
                    if (pc.iceConnectionState === 'connected') {
                        isP2P = true;
                        updateStatus('DIRECT P2P', 'p2p');
                    }
                };

                pc.ondatachannel = (e) => bindDC(e.channel);
            }

            function bindDC(channel) {
                dc = channel;
                dc.onopen = () => addLog('ðŸš€ P2P DATA CHANNEL OPEN', '#00ff88');
                dc.onmessage = (e) => handleData(JSON.parse(e.data), true);
            }

            async function handleSignalling(msg) {
                const {from, type, payload} = msg;
                if (type === 'offer') {
                    targetId = from;
                    setupPC();
                    await pc.setRemoteDescription(new RTCSessionDescription(payload));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    sendRelay('answer', answer);
                    iceCandidatesBuffer.forEach(c => pc.addIceCandidate(c));
                    iceCandidatesBuffer = [];
                } else if (type === 'answer') {
                    await pc.setRemoteDescription(new RTCSessionDescription(payload));
                    iceCandidatesBuffer.forEach(c => pc.addIceCandidate(c));
                    iceCandidatesBuffer = [];
                } else if (type === 'candidate') {
                    if (pc && pc.remoteDescription) pc.addIceCandidate(new RTCIceCandidate(payload));
                    else iceCandidatesBuffer.push(new RTCIceCandidate(payload));
                } else if (type === 'relay-data') {
                    handleData(payload, false);
                }
            }

            function handleData(data, fromP2P) {
                if (data.type === 'ping') {
                    sendData({type: 'pong', t: data.t});
                } else if (data.type === 'pong') {
                    const rtt = Date.now() - data.t;
                    document.getElementById('ping-display').innerText = `Ping: ${rtt}ms (${fromP2P ? 'P2P' : 'Relay'})`;
                    document.getElementById('ping-display').style.color = fromP2P ? '#00ff88' : '#ffcc00';
                }
            }

            function sendData(data) {
                if (isP2P && dc && dc.readyState === 'open') {
                    dc.send(JSON.stringify(data));
                } else {
                    sendRelay('relay-data', data);
                }
            }

            function sendRelay(type, payload) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({target: targetId, type, payload}));
                }
            }

            // Auto-ping loop
            setInterval(() => {
                if (targetId) sendData({type: 'ping', t: Date.now()});
            }, 2000);

            initWS();
        </script>
    </body>
</html>