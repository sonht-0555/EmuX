<!DOCTYPE html>
<html>
<head>
    <title>Universal Core Tester</title>
    <style>
        body { background: #111; color: #fff; text-align: center; font-family: sans-serif; padding: 20px; }
        .box { border: 1px solid #333; padding: 20px; border-radius: 10px; background: #222; display: inline-block; text-align: left; }
        canvas { background: #000; image-rendering: pixelated; width: 100%; max-width: 600px; margin-top: 20px; border: 2px solid #444; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em; }
        button { width: 100%; padding: 12px; background: #20A5A6; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #status { margin-top: 15px; color: #0f0; font-family: monospace; text-align: center; }
    </style>
</head>
<body>
    <h2>EmuX Universal Core Tester</h2>
    <div class="box">
        <div class="input-group">
            <label>1. Tên file Core (trong thư mục src/core/):</label>
            <input type="text" id="coreName" value="genesis" placeholder="ví dụ: genesis, ngp, ps1">
        </div>
        <div class="input-group">
            <label>2. Chọn ROM game tương ứng:</label>
            <input type="file" id="romInput">
        </div>
        <button id="startBtn">KHỞI CHẠY</button>
        <div id="status">Sẵn sàng.</div>
    </div>
    <br>
    <canvas id="canvas"></canvas>

    <script>
        const status = (m) => document.getElementById('status').innerText = m;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let isRunning = false;

        // Video Render đa năng (Hỗ trợ cả 16-bit và 32-bit)
        function video_cb(pointer, width, height, pitch) {
            if (canvas.width !== width || canvas.height !== height) {
                canvas.width = width; canvas.height = height;
            }
            const imgData = ctx.createImageData(width, height);
            const data = imgData.data;
            const bpp = pitch / width;
            if (bpp === 4) { // 32-bit (XRGB8888)
                const src = new Uint32Array(Module.HEAPU8.buffer, pointer, width * height);
                for (let i = 0; i < src.length; i++) {
                    const c = src[i];
                    data[i*4] = (c>>16)&0xFF; data[i*4+1] = (c>>8)&0xFF; data[i*4+2] = c&0xFF; data[i*4+3] = 255;
                }
            } else { // 16-bit (RGB565)
                const src = new Uint16Array(Module.HEAPU8.buffer, pointer, width * height);
                for (let i = 0; i < src.length; i++) {
                    const c = src[i];
                    data[i*4] = ((c>>11)&0x1F)<<3; data[i*4+1] = ((c>>5)&0x3F)<<2; data[i*4+2] = (c&0x1F)<<3; data[i*4+3] = 255;
                }
            }
            ctx.putImageData(imgData, 0, 0);
        }

        // Dummy callbacks
        function audio_cb() {}
        function audio_batch_cb(d, f) { return f; }
        function input_poll_cb() {}
        function input_state_cb() { return 0; }
        function env_cb(cmd, data) {
            if (cmd === 10) return 1;
            if (cmd === 31 || cmd === 37) {
                const w = Module.HEAP32[data >> 2], h = Module.HEAP32[(data >> 2) + 1];
                if (w > 0 && h > 0) { canvas.width = w; canvas.height = h; }
                return 1;
            }
            return 0;
        }

        document.getElementById('startBtn').onclick = async () => {
            const coreName = document.getElementById('coreName').value.trim();
            const romFile = document.getElementById('romInput').files[0];
            if (!romFile) return alert("Chọn ROM đã bạn ơi!");

            status(`Đang nạp core: ${coreName}.js ...`);
            const romData = new Uint8Array(await romFile.arrayBuffer());

            window.Module = {
                canvas: canvas,
                locateFile: (path) => path.endsWith('.wasm') ? `./src/core/${coreName}.wasm` : path,
                async onRuntimeInitialized() {
                    status("VFS Setup...");
                    const romPath = "/game.bin";
                    Module.FS.writeFile(romPath, romData);

                    const infoPtr = Module._malloc(16);
                    const pathPtr = Module._malloc(256);
                    Module.stringToUTF8(romPath, pathPtr, 256);

                    [[_retro_set_environment, env_cb, "iii"], 
                     [_retro_set_video_refresh, video_cb, "viiii"], 
                     [_retro_set_audio_sample, audio_cb, "vii"], 
                     [_retro_set_audio_sample_batch, audio_batch_cb, "iii"], 
                     [_retro_set_input_poll, input_poll_cb, "v"], 
                     [_retro_set_input_state, input_state_cb, "iiiii"]
                    ].forEach(([f, cb, sig]) => f(Module.addFunction(cb, sig)));

                    Module._retro_init();
                    Module.HEAP32[infoPtr >> 2] = pathPtr;
                    Module.HEAP32[(infoPtr >> 2) + 1] = Module.HEAP32[(infoPtr >> 2) + 2] = Module.HEAP32[(infoPtr >> 2) + 3] = 0;
                    
                    if (Module._retro_load_game(infoPtr)) {
                        status(`Core ${coreName} đang CHẠY!`);
                        isRunning = true;
                        (function loop() { if(isRunning) { Module._retro_run(); requestAnimationFrame(loop); } })();
                    } else { status("Lỗi: Core không nạp được game."); }
                }
            };

            const script = document.createElement('script');
            script.src = `./src/core/${coreName}.js`;
            document.body.appendChild(script);
        };
    </script>
</body>
</html>
