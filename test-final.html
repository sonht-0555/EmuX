<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>EmuX Master v6.0 (Survival Edition)</title>
        <style>
            :root {
                --bg: #0a0c10;
                --surface: #161b22;
                --primary: #58a6ff;
                --accent: #238636;
                --text: #c9d1d9;
                --dim: #8b949e;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
                background: var(--bg);
                color: var(--text);
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                padding: 20px;
            }

            .container {
                width: 100%;
                max-width: 360px;
                background: var(--surface);
                border-radius: 12px;
                border: 1px solid #30363d;
                padding: 24px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            }

            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 24px;
            }

            .status-badge {
                font-size: 10px;
                font-weight: bold;
                padding: 2px 8px;
                border-radius: 10px;
                background: #21262d;
                border: 1px solid #30363d;
            }

            .main-info {
                text-align: center;
                margin-bottom: 24px;
            }

            .id-label {
                font-size: 11px;
                color: var(--dim);
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            #my-id {
                display: block;
                font-size: 42px;
                font-weight: 800;
                color: #fff;
                letter-spacing: 4px;
                margin: 4px 0;
            }

            .ping-row {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 12px;
                font-size: 14px;
            }

            #rtt {
                font-weight: 600;
                color: #3fb950;
            }

            #conn-mode {
                color: var(--dim);
                font-size: 11px;
                text-transform: uppercase;
            }

            .control-group {
                display: flex;
                gap: 8px;
                margin-bottom: 16px;
            }

            input {
                flex: 1;
                min-width: 0;
                background: #0d1117;
                border: 1px solid #30363d;
                border-radius: 6px;
                color: #fff;
                padding: 10px 12px;
                font-size: 16px;
                font-family: inherit;
                outline: none;
                transition: border-color 0.2s;
            }

            input:focus {
                border-color: var(--primary);
            }

            button {
                background: #238636;
                color: #fff;
                border: 1px solid rgba(240, 246, 252, 0.1);
                border-radius: 6px;
                padding: 0 20px;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s;
                flex-shrink: 0;
            }

            button:hover {
                background: #2ea043;
            }

            button:active {
                transform: translateY(1px);
            }

            #log {
                font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, monospace;
                font-size: 11px;
                color: var(--dim);
                height: 120px;
                overflow-y: auto;
                border-top: 1px solid #30363d;
                padding-top: 12px;
                line-height: 1.6;
            }

            #log span {
                opacity: 0.5;
                margin-right: 8px;
            }

            /* Status Dot cho P2P */
            #status-dot {
                display: none;
            }

            /* áº¨n Ä‘i vÃ¬ Ä‘Ã£ cÃ³ chá»¯ P2P/Relay tinh táº¿ hÆ¡n */

            #log::-webkit-scrollbar {
                width: 4px;
            }

            #log::-webkit-scrollbar-thumb {
                background: #30363d;
                border-radius: 10px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <span style="font-weight: 700; font-size: 14px; color: var(--primary);">EmuX Master 1.2</span>
                <div id="ws-state" class="status-badge" style="color: #f85149;">OFFLINE</div>
            </header>

            <div class="main-info">
                <div class="id-label">Device Node ID</div>
                <div id="my-id">....</div>
                <div class="ping-row">
                    <span id="rtt">-- ms</span>
                    <span id="conn-mode">Standby</span>
                </div>
                <div id="status-dot"></div> <!-- Giá»¯ ID nÃ y Ä‘á»ƒ trÃ¡nh lá»—i JS -->
            </div>

            <div class="control-group">
                <input type="text" id="target-id" placeholder="Peer ID" maxlength="4" autocomplete="off" oninput="this.value=this.value.toUpperCase()">
                <button onclick="connect()">Connect</button>
            </div>

            <div id="log"></div>
        </div>

        <script>
            const RELAY_URL = 'wss://emux-relay.fly.dev/ws';
            const myId = Math.random().toString(36).substring(2, 6).toUpperCase();
            document.getElementById('my-id').innerText = myId;

            let ws, pc, dc, targetId;
            let isP2P = false;
            const logEl = document.getElementById('log');

            function addLog(msg, color = '#789') {
                const div = document.createElement('div');
                div.style.color = color;
                div.innerHTML = `<span style="opacity:0.4">${new Date().toLocaleTimeString('vi-VN')}</span> ${msg}`;
                logEl.appendChild(div);
                logEl.scrollTop = logEl.scrollHeight;
            }

            // 1. WebSocket - LuÃ´n lÃ  xÆ°Æ¡ng sá»‘ng + Heartbeat cho Mobile
            function initWS() {
                ws = new WebSocket(`${RELAY_URL}?id=${myId}`);
                ws.binaryType = 'arraybuffer';

                // Heartbeat chá»‘ng Ä‘Ã³ng bÄƒng máº¡ng trÃªn Mobile
                const hb = setInterval(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(new Uint8Array([0, 0, 0, 0, 0])); // Pack siÃªu nhá» 5 bytes
                    }
                }, 3000);

                ws.onopen = () => {
                    document.getElementById('ws-state').innerText = 'â— SERVER READY';
                    document.getElementById('ws-state').style.color = '#00ff88';
                    addLog('âœ… RELAY CLOUD CONNECTED', '#00ff88');
                };

                ws.onmessage = async (e) => {
                    if (e.data instanceof ArrayBuffer) {
                        const data = new Uint8Array(e.data);
                        if (data.length <= 5) return; // Bá» qua heartbeat
                        const from = new TextDecoder().decode(data.slice(0, 4));
                        handleGameData(from, data.slice(4));
                        return;
                    }
                    const msg = JSON.parse(e.data);
                    if (msg.from && msg.from !== myId) handleSignal(msg);
                };

                ws.onclose = () => {
                    clearInterval(hb);
                    setTimeout(initWS, 2000);
                };
            }

            // Tá»± Ä‘á»™ng há»“i sinh káº¿t ná»‘i khi Mobile quay láº¡i tab (Focus)
            window.addEventListener('focus', () => {
                if (!ws || ws.readyState === WebSocket.CLOSED) {
                    addLog('ðŸ”„ RECOVERING CONNECTION...', '#ffcc00');
                    initWS();
                }
            });

            // 2. Báº¯t Ä‘áº§u phiÃªn káº¿t ná»‘i
            async function connect() {
                targetId = document.getElementById('target-id').value.toUpperCase();
                if (!targetId || targetId === myId) return;

                addLog(`ðŸš€ INITIATING HYBRID PATH TO ${targetId}...`);
                setupPC();

                dc = pc.createDataChannel('game', {ordered: false, maxRetransmits: 0});
                setupDC(dc);

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                sendSignal({type: 'offer', sdp: offer});

                // Báº¯t Ä‘áº§u Ping (VÃ²ng láº·p vÄ©nh cá»­u)
                startPingLoop();
            }

            function setupPC() {
                pc = new RTCPeerConnection({
                    iceServers: [
                        {urls: 'stun:stun.l.google.com:19302'},
                        {urls: 'stun:stun.cloudflare.com:3478'},
                        {urls: 'turn:a.relay.metered.ca:80', username: 'e7b4b4e3a5f7d2c1b0a9', credential: 'e7b4b4e3a5f7d2c1b0a9'},
                        {urls: 'turn:a.relay.metered.ca:443', username: 'e7b4b4e3a5f7d2c1b0a9', credential: 'e7b4b4e3a5f7d2c1b0a9'},
                        {urls: 'turn:a.relay.metered.ca:443?transport=tcp', username: 'e7b4b4e3a5f7d2c1b0a9', credential: 'e7b4b4e3a5f7d2c1b0a9'},
                        {urls: 'turns:a.relay.metered.ca:443?transport=tcp', username: 'e7b4b4e3a5f7d2c1b0a9', credential: 'e7b4b4e3a5f7d2c1b0a9'},
                    ],
                    iceCandidatePoolSize: 10,
                    bundlePolicy: 'max-bundle'
                });

                pc.onicecandidate = (e) => {
                    if (e.candidate) {
                        const c = e.candidate.candidate;
                        const type = c.split(' ')[7];
                        const isIPv6 = c.indexOf(':') !== -1 && c.indexOf('.') === -1;

                        // VPN/WARP/Tailscale Detection
                        if (c.includes('10.') || c.includes('172.') || c.includes('tailscale')) {
                            addLog('ðŸ›¡ï¸ VPN/Tunnel Detected', '#58a6ff');
                        }

                        // Network Type Auto-Label
                        let netLabel = 'WIFI';
                        if (type === 'srflx') netLabel = 'MOBILE/NAT';
                        if (type === 'relay') netLabel = 'TURN RELAY';
                        document.getElementById('conn-mode').innerText = netLabel;

                        // IPv6 Priority Feedback
                        if (isIPv6) addLog(`ðŸŸ£ IPv6 PRIORITY: ${type}`, '#cc88ff');
                        else addLog(`ðŸ“¡ ICE: ${type}`, '#666');

                        sendSignal({type: 'candidate', candidate: e.candidate});
                    }
                };

                pc.oniceconnectionstatechange = () => {
                    const s = pc.iceConnectionState;
                    addLog(`ðŸŒ Node: ${s}`, '#8b949e');
                    if (s === 'connected' || s === 'completed') {
                        isP2P = true;
                        document.getElementById('conn-mode').innerText = 'DIRECT P2P';
                        document.getElementById('conn-mode').style.color = '#3fb950';
                        addLog('âš¡ P2P STABLE - LOW LATENCY', '#3fb950');
                    } else if (s === 'failed') {
                        addLog('âŒ P2P Failed. Try 4G/WARP!', '#f85149');
                    }
                };

                pc.ondatachannel = (e) => setupDC(e.channel);
            }

            function setupDC(channel) {
                dc = channel;
                dc.binaryType = 'arraybuffer';
                dc.onmessage = (e) => handleGameData(targetId, new Uint8Array(e.data));
            }

            // 3. Xá»­ lÃ½ dá»¯ liá»‡u (DÃ¹ lÃ  tá»« Relay hay P2P)
            function handleGameData(from, payload) {
                const type = payload[0];
                if (type === 1) { // Ping
                    const pong = new Uint8Array(9);
                    pong[0] = 2; pong.set(payload.slice(1), 1);
                    sendData(pong);
                } else if (type === 2) { // Pong
                    const sentTime = new DataView(payload.buffer, payload.byteOffset + 1).getFloat64(0);
                    const rtt = Date.now() - sentTime;
                    document.getElementById('rtt').innerText = `${Math.floor(rtt)} ms`;
                }
            }

            // 4. Gá»­i dá»¯ liá»‡u (ThÃ´ng minh)
            function sendData(payload) {
                // Æ¯u tiÃªn P2P, náº¿u chÆ°a thÃ´ng thÃ¬ dÃ¹ng Relay
                if (isP2P && dc && dc.readyState === 'open') {
                    dc.send(payload);
                } else if (ws && ws.readyState === WebSocket.OPEN) {
                    // Format Relay: [TargetID(4)][Payload]
                    const relayMsg = new Uint8Array(4 + payload.length);
                    relayMsg.set(new TextEncoder().encode(targetId), 0);
                    relayMsg.set(payload, 4);
                    ws.send(relayMsg);
                }
            }

            function sendSignal(data) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({target: targetId, from: myId, ...data}));
                }
            }

            async function handleSignal(msg) {
                if (msg.type === 'offer') {
                    targetId = msg.from;
                    setupPC();
                    await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    sendSignal({type: 'answer', sdp: answer});
                    startPingLoop();
                } else if (msg.type === 'answer') {
                    await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
                } else if (msg.type === 'candidate') {
                    pc.addIceCandidate(new RTCIceCandidate(msg.candidate)).catch(() => { });
                }
            }

            let pingStarted = false;
            function startPingLoop() {
                if (pingStarted) return;
                pingStarted = true;
                setInterval(() => {
                    if (!targetId) return;
                    const ping = new Uint8Array(9);
                    ping[0] = 1;
                    new DataView(ping.buffer).setFloat64(1, Date.now());
                    sendData(ping);
                }, 1000);
            }

            initWS();
        </script>
    </body>
</html>