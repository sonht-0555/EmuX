<!DOCTYPE html>
<html>
<body>
    <input type="file" id="f">
    <canvas id="c"></canvas>
    <script>
        const canvas = document.getElementById('c'), ctx = canvas.getContext('2d');
        document.getElementById('f').onchange = async (e) => {
            const data = new Uint8Array(await e.target.files[0].arrayBuffer());
            window.Module = {
                canvas: canvas,
                locateFile: (p) => p.endsWith('.wasm') ? './src/core/ngp.wasm' : p,
                onRuntimeInitialized() {
                    Module.FS.writeFile('/g.ngp', data);
                    const romPtr = Module._malloc(data.length), info = Module._malloc(32), path = Module._malloc(32);
                    Module.HEAPU8.set(data, romPtr);
                    Module.stringToUTF8('/g.ngp', path, 32);

                    const cb = (f, c, s) => f && f(Module.addFunction(c, s));
                    cb(Module._retro_set_environment, (cmd, d) => cmd === 10, "iii");
                    cb(Module._retro_set_video_refresh, (ptr, w, h, p) => {
                        if (canvas.width !== w) { canvas.width = w; canvas.height = h; }
                        const img = ctx.createImageData(w, h), src = new Uint16Array(Module.HEAPU8.buffer, ptr, w*h);
                        for(let i=0; i<src.length; i++) {
                            const c = src[i];
                            img.data.set([((c>>11)&31)<<3, ((c>>5)&63)<<2, (c&31)<<3, 255], i*4);
                        }
                        ctx.putImageData(img, 0, 0);
                    }, "viiii");
                    // Các callback bắt buộc khác để tránh mismatch
                    cb(Module._retro_set_audio_sample, () => {}, "vii");
                    cb(Module._retro_set_audio_sample_batch, (d, f) => f, "iii");
                    cb(Module._retro_set_input_poll, () => {}, "v");
                    cb(Module._retro_set_input_state, () => 0, "iiiii");

                    Module._retro_init();
                    Module.HEAP32.set([path, romPtr, data.length, 0], info >> 2);
                    if (Module._retro_load_game(info)) {
                        (function loop() { Module._retro_run(); requestAnimationFrame(loop); })();
                    }
                }
            };
            const s = document.createElement('script'); s.src = './src/core/ngp.js'; document.body.appendChild(s);
        };
    </script>
</body>
</html>
