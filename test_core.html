<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>MAME2003 WASM Debug</title>
    <style>
        body {
            font-family: sans-serif;
            background: #222;
            color: #fff;
            padding: 20px;
        }

        canvas {
            border: 2px solid #555;
            background: #000;
        }

        #status {
            margin: 10px 0;
            color: #0f0;
        }

        #log {
            font-family: monospace;
            font-size: 12px;
            background: #000;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #444;
        }
    </style>
</head>

<body>
    <h1>MAME2003 Debugging</h1>
    <input type="file" id="romInput" accept=".zip">
    <div id="status">Waiting for ROM...</div>
    <div id="log"></div>
    <canvas id="canvas" width="320" height="240"></canvas>

    <script>
        const logger = (msg, color = '#fff') => {
            const l = document.getElementById('log');
            const d = document.createElement('div');
            d.style.color = color;
            d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            l.appendChild(d);
            l.scrollTop = l.scrollHeight;
            console.log(msg);
        };

        function env_cb(cmd, data) {
            logger(`env_cb called: cmd=${cmd} (0x${cmd.toString(16)}), data=${data} (0x${(data || 0).toString(16)})`);
            // Some cores might pass data as a 64-bit int or shifted if there's an ABI mismatch
            if (cmd > 0xFFFF) {
                logger(`  !! Extreme cmd value detected. This strongly suggests an ABI mismatch (e.g. 32-bit vs 64-bit or calling convention error).`, "#f00");
            }
            switch (cmd) {
                case 1: // SET_ROTATION
                    return 1;
                case 2: // GET_CAN_DUPE
                    if (data) Module.HEAP8[data] = 1;
                    return 1;
                case 8: // GET_SYSTEM_DIRECTORY
                case 9: // GET_SAVE_DIRECTORY
                case 31: // GET_CORE_ASSETS_DIRECTORY
                    const dir = "/home/web_user/retroarch";
                    try { if (!Module.FS.analyzePath(dir).exists) Module.FS.mkdirTree(dir); } catch (e) { }
                    const ptr = Module._malloc(dir.length + 1);
                    Module.stringToUTF8(dir, ptr, dir.length + 1);
                    Module.HEAP32[data >> 2] = ptr;
                    logger(`  -> provided directory: ${dir}`);
                    return 1;
                case 10: // SET_PIXEL_FORMAT
                    const fmt = Module.HEAP32[data >> 2];
                    logger(`  -> Core requested pixel format: ${fmt}`);
                    return 1;
                default:
                    return 0;
            }
        }

        function video_cb(data, w, h, p) { if (Module.ctx) Module.ctx.fillRect(0, 0, 10, 10); }
        function audio_cb(l, r) { }
        function audio_batch_cb(d, f) { return f; }
        function input_poll_cb() { }
        function input_state_cb(p, d, i, id) { return 0; }

        document.getElementById('romInput').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const buffer = await file.arrayBuffer();
            const romData = new Uint8Array(buffer);

            window.Module = {
                canvas: document.getElementById('canvas'),
                ctx: document.getElementById('canvas').getContext('2d'),
                locateFile: (p) => p.endsWith('.wasm') ? 'src/core/mame2003_libretro.wasm' : p,
                onRuntimeInitialized: async function () {
                    logger("WASM Initialized", "#0f0");

                    try {
                        const namePtr = Module._malloc(file.name.length + 1);
                        Module.stringToUTF8(file.name, namePtr, file.name.length + 1);
                        const romPtr = Module._malloc(romData.length);
                        Module.HEAPU8.set(romData, romPtr);
                        const info = Module._malloc(16);
                        Module.HEAP32[(info >> 2) + 0] = namePtr;
                        Module.HEAP32[(info >> 2) + 1] = romPtr;
                        Module.HEAP32[(info >> 2) + 2] = romData.length;
                        Module.HEAP32[(info >> 2) + 3] = 0;

                        logger("Registering callbacks...");
                        Module._retro_set_environment(Module.addFunction(env_cb, "iii"));
                        Module._retro_set_video_refresh(Module.addFunction(video_cb, "viiii"));
                        Module._retro_set_audio_sample(Module.addFunction(audio_cb, "vii"));
                        Module._retro_set_audio_sample_batch(Module.addFunction(audio_batch_cb, "iii"));
                        Module._retro_set_input_poll(Module.addFunction(input_poll_cb, "v"));
                        Module._retro_set_input_state(Module.addFunction(input_state_cb, "iiiii"));

                        logger("Initializing core...");
                        Module._retro_init();

                        logger("Testing retro_load_game with ccall...");

                        // Using ccall is more robust as it handles type conversion and 
                        // sometimes avoids direct table call signature traps.
                        try {
                            const res = Module.ccall('retro_load_game', 'number', ['number'], [info]);
                            if (res) {
                                logger(`Success! Game loaded successfully. Result: ${res}`, "#0f0");
                                document.getElementById('status').innerText = "Running!";
                                const loop = () => { Module._retro_run(); requestAnimationFrame(loop); };
                                requestAnimationFrame(loop);
                            } else {
                                logger("Failed to load game (core returned 0)", "#f00");
                                document.getElementById('status').innerText = "Load failed (Check ROM/BIOS)";
                            }
                        } catch (e) {
                            logger(`ccall failed: ${e.message}`, "#f00");
                            if (e.message.includes("signature mismatch")) {
                                logger("CRITICAL: Still a signature mismatch. Please ensure you have downloaded the LATEST .wasm and .js from GitHub Actions (built after 10:15 AM) and cleared your browser cache (Cmd+Shift+R).", "#ff0");
                            }
                        }
                    } catch (e) {
                        logger("Global error: " + e.message, "#f00");
                    }
                },
            };

            const script = document.createElement('script');
            script.src = 'src/core/mame2003_libretro.js';
            document.body.appendChild(script);
        });
    </script>
</body>

</html>